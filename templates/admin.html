{% extends "base.html" %}
{% block title %}Admin Dashboard - AI Strategy Consultant{% endblock %}
{% block extra_head %}
<style>
    .admin-container {
        max-width: 1400px;
        margin: 2rem auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        padding: 2rem;
        text-align: center;
        border-radius: 12px 12px 0 0;
    }
    
    .admin-controls {
        padding: 2rem;
        background: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .control-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-refresh {
        background: #3b82f6;
        color: white;
    }
    
    .btn-export {
        background: #10b981;
        color: white;
    }
    
    .btn-clear {
        background: #ef4444;
        color: white;
    }
    
    .btn-trends {
        background: #8b5cf6;
        color: white;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .data-table th {
        background: #374151;
        color: white;
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
    }
    
    .data-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 13px;
    }
    
    .data-table tr:hover {
        background: #f8fafc;
    }

    /* DB view helpers */
    .truncate { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 260px; display: inline-block; vertical-align: top; }
    .db-id { cursor: pointer; color: #2563eb; font-weight: 700; }
    .db-details { background: #f9fafb; }
    .kv-grid { display: grid; grid-template-columns: 240px 1fr; gap: 6px 12px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace; }
    .kv-grid .k { font-weight: 600; color: #374151; }
    .kv-grid .v { background:#fff; border:1px solid #e5e7eb; border-radius:6px; padding:6px; white-space:pre-wrap; word-break:break-word; }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .action-btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
        cursor: pointer;
    }
    
    .btn-view {
        background: #3b82f6;
        color: white;
    }
    
    .btn-edit {
        background: #f59e0b;
        color: white;
    }
    
    .btn-delete {
        background: #ef4444;
        color: white;
    }
    
    .score-badge {
        background: #10b981;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 11px;
    }
    
    .table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
    }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 2% auto;
        padding: 20px;
        border-radius: 8px;
        width: 80%;
        max-width: 600px;
        max-height: 90vh;
        overflow-y: auto;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #000;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .form-group textarea {
        height: 80px;
        resize: vertical;
    }
    
    /* Trends Dashboard Styles */
    .trends-dashboard {
        display: none;
        padding: 2rem;
        background: #f8fafc;
    }
    
    .trends-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .trend-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }
    
    .trend-card h3 {
        color: #374151;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }
    
    .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 6px;
    }
    
    .metric-label {
        font-weight: 600;
        color: #374151;
    }
    
    .metric-value {
        font-weight: bold;
        color: #059669;
    }
    
    .chart-container {
        height: 200px;
        margin-top: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-style: italic;
    }
    
    .industry-bar {
        background: #3b82f6;
        height: 20px;
        border-radius: 10px;
        margin: 0.25rem 0;
        position: relative;
        overflow: hidden;
    }
    
    .industry-bar-fill {
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .industry-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .score-distribution {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .score-range {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        background: #f9fafb;
    }
    
    .score-range.high {
        background: #ecfdf5;
        border: 2px solid #10b981;
    }
    
    .score-range.medium {
        background: #fef3c7;
        border: 2px solid #f59e0b;
    }
    
    .score-range.low {
        background: #fef2f2;
        border: 2px solid #ef4444;
    }
    
    .score-number {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .score-label {
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .tool-trends {
        margin-top: 1rem;
    }
    
    .tool-category {
        margin-bottom: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
    }
    
    .tool-category h4 {
        margin: 0 0 0.5rem 0;
        color: #374151;
        font-size: 1rem;
    }
    
    .tool-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    
    .external-tool-indicator {
        color: #dc2626;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div style="background: #f8fafc; min-height: 100vh; padding: 2rem 0;">
    <div class="admin-container">
        <div class="admin-header">
            <h1>üîß Admin Dashboard</h1>
            <p>Manage Client Assessments & Monitor Trends</p>
        </div>
        
        <div class="admin-controls">
            <div class="controls-grid">
                <button class="control-btn btn-refresh" onclick="loadAssessments()">
                    üîÑ Refresh Data
                </button>
                <button class="control-btn btn-export" onclick="exportData()">
                    üìä Export CSV
                </button>
                <button class="control-btn btn-trends" onclick="toggleTrends()">
                    üìà Monitoring Trends
                </button>
                <button class="control-btn btn-clear" onclick="confirmClearAll()">
                    üóëÔ∏è Clear All Data
                </button>
                <button class="control-btn" onclick="addSampleData()" style="background: #8b5cf6; color: white;">
                    ‚ûï Add Sample Data
                </button>
                <button class="control-btn" onclick="toggleDbView()" style="background: #0ea5e9; color: white;">
                    üßÆ DB View
                </button>
            </div>
        </div>
        
        <!-- Trends Dashboard -->
        <div id="trendsDashboard" class="trends-dashboard">
            <div class="trends-grid">
                <!-- Assessment Overview -->
                <div class="trend-card">
                    <h3>üìä Assessment Overview</h3>
                    <div id="assessmentOverview">
                        <div class="metric">
                            <span class="metric-label">Total Assessments</span>
                            <span class="metric-value" id="totalAssessments">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">This Month</span>
                            <span class="metric-value" id="monthlyAssessments">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average AI Score</span>
                            <span class="metric-value" id="avgAiScore">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Reports Generated</span>
                            <span class="metric-value" id="reportsGenerated">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Industry Distribution -->
                <div class="trend-card">
                    <h3>üè≠ Industry Distribution</h3>
                    <div id="industryDistribution">
                        <!-- Industry data will be populated here -->
                    </div>
                </div>
                
                <!-- AI Score Distribution -->
                <div class="trend-card">
                    <h3>üéØ AI Score Distribution</h3>
                    <div class="score-distribution">
                        <div class="score-range high">
                            <div class="score-number" id="highScoreCount">-</div>
                            <div class="score-label">High (80-100)</div>
                        </div>
                        <div class="score-range medium">
                            <div class="score-number" id="mediumScoreCount">-</div>
                            <div class="score-label">Medium (50-79)</div>
                        </div>
                        <div class="score-range low">
                            <div class="score-number" id="lowScoreCount">-</div>
                            <div class="score-label">Low (0-49)</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tool Recommendation Trends -->
                <div class="trend-card">
                    <h3>üõ†Ô∏è Tool Recommendation Trends</h3>
                    <div id="toolTrends" class="tool-trends">
                        <!-- Tool trends will be populated here -->
                    </div>
                </div>
                
                <!-- External Tools Analysis -->
                <div class="trend-card">
                    <h3>üîó External Tool Analysis</h3>
                    <div id="externalToolsAnalysis">
                        <div class="metric">
                            <span class="metric-label">External Tools Recommended</span>
                            <span class="metric-value" id="externalToolsCount">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Most Requested Category</span>
                            <span class="metric-value" id="mostRequestedCategory">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Portfolio Expansion Opportunities</span>
                            <span class="metric-value" id="expansionOpportunities">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Revenue Tracking -->
                <div class="trend-card">
                    <h3>üí∞ Revenue Tracking</h3>
                    <div id="revenueTracking">
                        <div class="metric">
                            <span class="metric-label">Total Revenue Potential</span>
                            <span class="metric-value" id="totalRevenuePotential">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average Deal Size</span>
                            <span class="metric-value" id="avgDealSize">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Conversion Rate</span>
                            <span class="metric-value" id="conversionRate">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-container">
            <div id="loadingMessage" class="loading">
                Loading assessment data...
            </div>
            
            <table class="data-table" id="assessmentsTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Company</th>
                        <th>Contact</th>
                        <th>Email</th>
                        <th>Industry</th>
                        <th>AI Score</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="assessmentsTableBody">
                    <!-- Data will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- DB Visibility Table -->
        <div class="table-container" id="dbViewContainer" style="display:none; margin-top:1rem;">
            <h3 style="margin:0 0 8px 0; color:#374151;">Database View (raw)</h3>
            <div id="dbTableWrapper" style="overflow:auto; max-height:60vh; border:1px solid #e5e7eb; border-radius:8px; background:#fff;"></div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div id="viewModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close" onclick="closeModal('viewModal')">&times;</span>
        <h2>üìã Assessment Details</h2>
        <div id="viewModalContent">
            <!-- Assessment details will be loaded here -->
        </div>
    </div>
</div>

<!-- DB Inspector Modal -->
<div id="dbInspectorModal" class="modal">
    <div class="modal-content" style="max-width: 1000px;">
        <span class="close" onclick="closeModal('dbInspectorModal')">&times;</span>
        <h2>üßÆ Database Inspector</h2>
        <div id="dbInspectorContent" style="max-height:70vh;overflow:auto;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace;"></div>
    </div>
 </div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal('editModal')">&times;</span>
        <h2>Edit Assessment</h2>
        <form id="editForm">
            <input type="hidden" id="editId">
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Company Name</label>
                    <input type="text" id="editCompanyName" required>
                </div>
                <div class="form-group">
                    <label>Industry</label>
                    <select id="editIndustry">
                        <option value="automotive">Automotive</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="manufacturing">Manufacturing</option>
                        <option value="retail">Retail</option>
                        <option value="professional-services">Professional Services</option>
                        <option value="technology">Technology</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>First Name</label>
                    <input type="text" id="editFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name</label>
                    <input type="text" id="editLastName" required>
                </div>
            </div>
            
            <div class="form-group">
                <label>Email</label>
                <input type="email" id="editEmail" required>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Company Size</label>
                    <select id="editCompanySize">
                        <option value="10-50">10-50 employees</option>
                        <option value="51-100">51-100 employees</option>
                        <option value="101-250">101-250 employees</option>
                        <option value="251-500">251-500 employees</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>AI Score</label>
                    <input type="number" id="editAiScore" min="0" max="100">
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="button" class="control-btn btn-refresh" onclick="saveAssessment()">
                    üíæ Save Changes
                </button>
                <button type="button" class="control-btn" onclick="closeModal('editModal')" style="background: #6b7280; color: white;">
                    ‚ùå Cancel
                </button>
            </div>
        </form>
    </div>
</div>

<script>
let assessments = [];
let trendsData = {};

// Load assessments when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadAssessments();
});

function toggleTrends() {
    const trendsDashboard = document.getElementById('trendsDashboard');
    const button = event.target;
    
    if (trendsDashboard.style.display === 'none' || trendsDashboard.style.display === '') {
        trendsDashboard.style.display = 'block';
        button.textContent = 'üìä Hide Trends';
        button.style.background = '#6b7280';
        loadTrendsData();
    } else {
        trendsDashboard.style.display = 'none';
        button.textContent = 'üìà Monitoring Trends';
        button.style.background = '#8b5cf6';
    }
}

function loadTrendsData() {
    if (assessments.length === 0) {
        loadAssessments().then(() => {
            calculateTrends();
        });
    } else {
        calculateTrends();
    }
}

function calculateTrends() {
    // Assessment Overview
    const totalAssessments = assessments.length;
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthlyAssessments = assessments.filter(a => {
        const date = new Date(a.created_at);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
    }).length;
    
    const avgAiScore = assessments.length > 0 ? 
        Math.round(assessments.reduce((sum, a) => sum + a.ai_score, 0) / assessments.length) : 0;
    
    // AI Score Distribution
    const highScores = assessments.filter(a => a.ai_score >= 80).length;
    const mediumScores = assessments.filter(a => a.ai_score >= 50 && a.ai_score < 80).length;
    const lowScores = assessments.filter(a => a.ai_score < 50).length;
    
    // Industry Distribution
    const industryCounts = {};
    assessments.forEach(a => {
        industryCounts[a.industry] = (industryCounts[a.industry] || 0) + 1;
    });
    
    // Tool Trends Analysis
    const toolCategories = ['customer_service', 'workflow_automation', 'development', 'business_intelligence'];
    const toolTrends = {};
    let externalToolsCount = 0;
    let externalToolCategories = {};
    
    assessments.forEach(assessment => {
        if (assessment.opportunities && Array.isArray(assessment.opportunities)) {
            assessment.opportunities.forEach(opp => {
                if (opp.solutions && Array.isArray(opp.solutions)) {
                    opp.solutions.forEach(sol => {
                        if (sol.type === 'External') {
                            externalToolsCount++;
                            const category = opp.category || 'unknown';
                            externalToolCategories[category] = (externalToolCategories[category] || 0) + 1;
                        }
                    });
                }
            });
        }
    });
    
    // Revenue Tracking
    const totalRevenuePotential = totalAssessments * 750; // $750 per assessment report
    const avgDealSize = 750;
    const conversionRate = totalAssessments > 0 ? Math.round((monthlyAssessments / totalAssessments) * 100) : 0;
    
    // Update UI
    document.getElementById('totalAssessments').textContent = totalAssessments;
    document.getElementById('monthlyAssessments').textContent = monthlyAssessments;
    document.getElementById('avgAiScore').textContent = avgAiScore + '%';
    document.getElementById('reportsGenerated').textContent = totalAssessments; // Assuming 1 report per assessment
    
    document.getElementById('highScoreCount').textContent = highScores;
    document.getElementById('mediumScoreCount').textContent = mediumScores;
    document.getElementById('lowScoreCount').textContent = lowScores;
    
    document.getElementById('externalToolsCount').textContent = externalToolsCount;
    document.getElementById('mostRequestedCategory').textContent = 
        Object.keys(externalToolCategories).length > 0 ? 
        Object.keys(externalToolCategories).reduce((a, b) => 
            externalToolCategories[a] > externalToolCategories[b] ? a : b) : 'None';
    document.getElementById('expansionOpportunities').textContent = 
        Object.keys(externalToolCategories).length;
    
    document.getElementById('totalRevenuePotential').textContent = '$' + totalRevenuePotential.toLocaleString();
    document.getElementById('avgDealSize').textContent = '$' + avgDealSize.toLocaleString();
    document.getElementById('conversionRate').textContent = conversionRate + '%';
    
    // Render Industry Distribution
    renderIndustryDistribution(industryCounts);
    
    // Render Tool Trends
    renderToolTrends(externalToolCategories);
}

function renderIndustryDistribution(industryCounts) {
    const container = document.getElementById('industryDistribution');
    const total = Object.values(industryCounts).reduce((sum, count) => sum + count, 0);
    
    let html = '';
    Object.entries(industryCounts)
        .sort(([,a], [,b]) => b - a)
        .forEach(([industry, count]) => {
            const percentage = Math.round((count / total) * 100);
            const displayName = industry.charAt(0).toUpperCase() + industry.slice(1).replace('-', ' ');
            
            html += `
                <div class="industry-label">
                    <span>${displayName}</span>
                    <span>${count} (${percentage}%)</span>
                </div>
                <div class="industry-bar">
                    <div class="industry-bar-fill" style="width: ${percentage}%"></div>
                </div>
            `;
        });
    
    container.innerHTML = html;
}

function renderToolTrends(externalToolCategories) {
    const container = document.getElementById('toolTrends');
    
    if (Object.keys(externalToolCategories).length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; font-style: italic;">No external tools recommended yet</p>';
        return;
    }
    
    let html = '';
    Object.entries(externalToolCategories)
        .sort(([,a], [,b]) => b - a)
        .forEach(([category, count]) => {
            const displayName = category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ');
            
            html += `
                <div class="tool-category">
                    <h4>${displayName}</h4>
                    <div class="tool-stats">
                        <span>External Tools: <span class="external-tool-indicator">${count}</span></span>
                        <span>Portfolio Gap: High</span>
                    </div>
                </div>
            `;
        });
    
    container.innerHTML = html;
}

function loadAssessments() {
    document.getElementById('loadingMessage').style.display = 'block';
    document.getElementById('assessmentsTable').style.display = 'none';
    
    return fetch('/api/assessments')
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingMessage').style.display = 'none';
            
            if (data.success) {
                assessments = data.assessments;
                displayAssessments(assessments);
                document.getElementById('assessmentsTable').style.display = 'table';
            } else {
                document.getElementById('loadingMessage').innerHTML = 'Error loading data: ' + (data.error || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('loadingMessage').innerHTML = 'Network error loading assessments';
        });
}

function displayAssessments(assessmentList) {
    const tbody = document.getElementById('assessmentsTableBody');
    tbody.innerHTML = '';
    
    if (assessmentList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #6b7280;">No assessments found</td></tr>';
        return;
    }
    
    assessmentList.forEach(assessment => {
        const row = document.createElement('tr');
        const createdDate = new Date(assessment.created_at).toLocaleDateString();
        
        row.innerHTML = `
            <td>${assessment.id}</td>
            <td>${assessment.company_name}</td>
            <td>${assessment.contact_name}</td>
            <td>${assessment.email}</td>
            <td>${assessment.industry}</td>
            <td><span class="score-badge">${assessment.ai_score}%</span></td>
            <td>${createdDate}</td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn btn-view" onclick="viewAssessment(${assessment.id})" title="View Details">üëÅÔ∏è</button>
                    <button class="action-btn" style="background:#0ea5e9;color:white" onclick="openDbInspector(${assessment.id})" title="DB Inspector">üßÆ</button>
                    <button class="action-btn btn-delete" onclick="deleteAssessment(${assessment.id})" title="Delete">üóëÔ∏è</button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function viewAssessment(id) {
    const assessment = assessments.find(a => a.id === id);
    if (!assessment) return;
    
    // Format challenges and opportunities
    const challenges = Array.isArray(assessment.challenges) ? assessment.challenges.join(', ') : 'None specified';
    let opportunities = 'None identified';
    if (Array.isArray(assessment.opportunities) && assessment.opportunities.length > 0) {
    opportunities = assessment.opportunities.map((opp, index) => 
        `<div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 6px; border-left: 3px solid #10b981;">
            <strong>${index + 1}. ${opp.title || 'Unnamed Opportunity'}</strong><br>
            <span style="color: #6b7280; font-size: 13px;">${opp.description || 'No description available'}</span><br>
            ${opp.roi ? `<span style="color: #059669; font-weight: 600;">Estimated ROI: $${opp.roi.toLocaleString()}</span>` : ''}
        </div>`
        ).join('');
    }
    
    const content = `
        <div style="line-height: 1.8; font-size: 14px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Company Information</h3>
                    <p><strong>Company Name:</strong> ${assessment.company_name}</p>
                    <p><strong>Industry:</strong> ${assessment.industry}</p>
                    <p><strong>Company Size:</strong> ${assessment.company_size || 'Not specified'}</p>
                    <p><strong>Primary Contact:</strong> ${assessment.contact_name}</p>
                    <p><strong>Role:</strong> ${assessment.role || 'Not specified'}</p>
                    <p><strong>Email:</strong> ${assessment.email}</p>
                    <p><strong>Phone:</strong> ${assessment.phone || 'Not provided'}</p>
                </div>
                
                <div>
                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">AI Readiness Assessment</h3>
                    <p><strong>AI Score:</strong> <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 16px; font-weight: bold;">${assessment.ai_score}%</span></p>
                    <p><strong>Current Tech Level:</strong> ${assessment.current_tech || 'Not specified'}</p>
                    <p><strong>AI Experience:</strong> ${assessment.ai_experience || 'Not specified'}</p>
                    <p><strong>Budget Range:</strong> ${assessment.budget || 'Not specified'}</p>
                    <p><strong>Timeline:</strong> ${assessment.timeline || 'Not specified'}</p>
                    <p><strong>Assessment Date:</strong> ${new Date(assessment.created_at).toLocaleString()}</p>
                </div>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Business Challenges</h3>
                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    ${challenges}
                </div>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">AI Opportunities</h3>
                <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                    ${opportunities}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <button onclick="generateReportFromView(${assessment.id})" style="background: #4f46e5; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 1rem;">
                    üìÑ Generate Assessment Report
                </button>
                <button onclick="editAssessmentFromView(${assessment.id})" style="background: #f59e0b; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    ‚úèÔ∏è Edit Assessment
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('viewModalContent').innerHTML = content;
    document.getElementById('viewModal').style.display = 'block';
}

function deleteAssessment(id) {
    if (!confirm('Are you sure you want to delete this assessment?')) {
        return;
    }
    
    fetch('/api/delete_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Assessment deleted successfully!');
        } else {
            alert('Error deleting assessment: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error deleting assessment');
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function exportData() {
    if (assessments.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Create CSV content
    const headers = ['ID', 'Company', 'Contact', 'Email', 'Industry', 'AI Score', 'Created'];
    const csvContent = [
        headers.join(','),
        ...assessments.map(a => [
            a.id,
            `"${a.company_name}"`,
            `"${a.contact_name}"`,
            a.email,
            a.industry,
            a.ai_score,
            new Date(a.created_at).toISOString().split('T')[0]
        ].join(','))
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `assessments_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function confirmClearAll() {
    if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL assessment data permanently. Are you sure?')) {
        return;
    }
    
    fetch('/api/clear_all_assessments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('All assessment data has been cleared.');
        } else {
            alert('Error clearing data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error clearing data');
    });
}

function addSampleData() {
    if (!confirm('Add sample assessment data for testing?')) {
        return;
    }
    
    fetch('/api/add_sample_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Sample data added successfully!');
        } else {
            alert('Error adding sample data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error adding sample data');
    });
}

// Additional helper functions
function openDbInspector(assessmentId) {
    const content = document.getElementById('dbInspectorContent');
    content.innerHTML = '<div class="loading">Loading raw database row‚Ä¶</div>';
    document.getElementById('dbInspectorModal').style.display = 'block';

    fetch(`/api/assessment_row/${assessmentId}`)
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                content.innerHTML = `<p style="color:#ef4444">Error: ${data.error || 'Unknown error'}</p>`;
                return;
            }
            const row = data.row || {};
            const container = document.createElement('div');
            container.style.display = 'grid';
            container.style.gridTemplateColumns = '300px 1fr';
            container.style.gap = '8px 16px';

            Object.entries(row).forEach(([col, val]) => {
                const keyEl = document.createElement('div');
                keyEl.style.fontWeight = '600';
                keyEl.textContent = col;
                const valEl = document.createElement('div');
                let pretty = '';
                if (typeof val === 'string' && (val.startsWith('[') || val.startsWith('{'))) {
                    try { pretty = JSON.stringify(JSON.parse(val), null, 2); } catch (e) { pretty = val; }
                } else {
                    pretty = String(val == null ? '' : val);
                }
                valEl.innerHTML = `<pre style="margin:0;background:#f8fafc;border:1px solid #e5e7eb;border-radius:6px;padding:8px;white-space:pre-wrap;">${pretty}</pre>`;
                container.appendChild(keyEl);
                container.appendChild(valEl);
            });

            content.innerHTML = '';
            content.appendChild(container);
        })
        .catch(err => {
            content.innerHTML = `<p style="color:#ef4444">Network error: ${err}</p>`;
        });
}
function generateReportFromView(assessmentId) {
    if (!confirm('Generate Assessment Report ($750) for this assessment?')) {
        return;
    }
    
    // Show generating status
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '‚è≥ Generating Report...';
    button.disabled = true;
    
    // Generate the report
    fetch('/generate_report_from_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            assessment_id: assessmentId,
            report_type: 'assessment'
        })
    })
    .then(response => response.json())
    .then(result => {
        button.textContent = originalText;
        button.disabled = false;
        
    if (result.success) {
        // Create download link
        const a = document.createElement('a');
        a.href = result.download_url;
        a.download = result.download_url.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert('‚úÖ Assessment Report generated successfully!');
    } else {
        alert('‚ùå Error generating report: ' + result.error);
    }
    })
    .catch(error => {
        button.textContent = originalText;
        button.disabled = false;
        alert('‚ùå Network error generating report');
        console.error('Error:', error);
    });
}

function editAssessmentFromView(assessmentId) {
    closeModal('viewModal');
    editAssessment(assessmentId);
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

// Toggle DB View and load raw table
function toggleDbView() {
  const container = document.getElementById('dbViewContainer');
  const visible = container.style.display !== 'none';
  if (visible) {
    container.style.display = 'none';
    return;
  }
  container.style.display = 'block';
  loadDbTable();
}

function loadDbTable() {
  const wrapper = document.getElementById('dbTableWrapper');
  wrapper.innerHTML = '<div class="loading">Loading database rows‚Ä¶</div>';
  fetch('/api/assessments_raw')
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        wrapper.innerHTML = `<p style="color:#ef4444">Error: ${data.error || 'Unknown error'}</p>`;
        return;
      }
      const cols = data.columns || [];
      const rows = data.rows || [];
      const visibleCols = ['id', 'company_name', 'email', 'industry', 'created_at'];
      const thead = `<thead><tr>${visibleCols.map(c => `<th>${c}</th>`).join('')}<th>raw</th></tr></thead>`;
      const bodyRows = rows.map((r, idx) => {
        const summaryTds = visibleCols.map(c => {
          const val = String(r[c] ?? '');
          return `<td class="truncate" title="${escapeHtml(val)}">${escapeHtml(val)}</td>`;
        }).join('');
        const details = `<tr class="db-details" id="db_details_${idx}" style="display:none;"><td colspan="${visibleCols.length + 1}"><div class="kv-grid">${cols.map(k => `<div class="k">${k}</div><div class="v">${formatValue(r[k])}</div>`).join('')}</div></td></tr>`;
        return `<tr><td class="db-id" onclick="toggleRow(${idx})">${escapeHtml(String(r['id'] ?? ''))}</td>${summaryTds}<td style="text-align:center"><span class="db-id" onclick="toggleRow(${idx})">‚ñ∂</span></td></tr>${details}`;
      }).join('');
      const tbody = `<tbody>${bodyRows}</tbody>`;
      wrapper.innerHTML = `<table class="data-table">${thead}${tbody}</table>`;
    })
    .catch(err => {
      wrapper.innerHTML = `<p style=\"color:#ef4444\">Network error: ${err}</p>`;
    });
}

function formatValue(val) {
  const s = String(val == null ? '' : val);
  if (s.startsWith('[') || s.startsWith('{')) {
    try { return escapeHtml(JSON.stringify(JSON.parse(s), null, 2)); } catch (e) { return escapeHtml(s); }
  }
  return escapeHtml(s);
}

function escapeHtml(str) {
  return str
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#39;');
}

function toggleRow(idx) {
  const row = document.getElementById(`db_details_${idx}`);
  if (!row) return;
  row.style.display = row.style.display === 'none' ? '' : 'none';
}

// Toggle DB View and load raw table
// (Removed duplicate legacy DB view functions)

function displayAssessments(assessmentList) {
    const tbody = document.getElementById('assessmentsTableBody');
    tbody.innerHTML = '';
    
    if (assessmentList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 2rem; color: #6b7280;">No assessments found</td></tr>';
        return;
    }
    
    assessmentList.forEach(assessment => {
        const row = document.createElement('tr');
        const createdDate = new Date(assessment.created_at).toLocaleDateString();
        
        row.innerHTML = `
            <td>${assessment.id}</td>
            <td>${assessment.company_name}</td>
            <td>${assessment.contact_name}</td>
            <td>${assessment.email}</td>
            <td>${assessment.industry}</td>
            <td><span class="score-badge">${assessment.ai_score}%</span></td>
            <td>${createdDate}</td>
            <td>
                <div class="action-buttons">
                    <button class="action-btn btn-view" onclick="viewAssessment(${assessment.id})" title="View Details">üëÅÔ∏è</button>
                    <button class="action-btn btn-delete" onclick="deleteAssessment(${assessment.id})" title="Delete">üóëÔ∏è</button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

function viewAssessment(id) {
    const assessment = assessments.find(a => a.id === id);
    if (!assessment) return;
    
    // Format challenges and opportunities
    const challenges = Array.isArray(assessment.challenges) ? assessment.challenges.join(', ') : 'None specified';
    let opportunities = 'None identified';
    if (Array.isArray(assessment.opportunities) && assessment.opportunities.length > 0) {
    opportunities = assessment.opportunities.map((opp, index) => 
        `<div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 6px; border-left: 3px solid #10b981;">
            <strong>${index + 1}. ${opp.title || 'Unnamed Opportunity'}</strong><br>
            <span style="color: #6b7280; font-size: 13px;">${opp.description || 'No description available'}</span><br>
            ${opp.roi ? `<span style="color: #059669; font-weight: 600;">Estimated ROI: $${opp.roi.toLocaleString()}</span>` : ''}
        </div>`
        ).join('');
    }
    
    const content = `
        <div style="line-height: 1.8; font-size: 14px;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Company Information</h3>
                    <p><strong>Company Name:</strong> ${assessment.company_name}</p>
                    <p><strong>Industry:</strong> ${assessment.industry}</p>
                    <p><strong>Company Size:</strong> ${assessment.company_size || 'Not specified'}</p>
                    <p><strong>Primary Contact:</strong> ${assessment.contact_name}</p>
                    <p><strong>Role:</strong> ${assessment.role || 'Not specified'}</p>
                    <p><strong>Email:</strong> ${assessment.email}</p>
                    <p><strong>Phone:</strong> ${assessment.phone || 'Not provided'}</p>
                </div>
                
                <div>
                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">AI Readiness Assessment</h3>
                    <p><strong>AI Score:</strong> <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 16px; font-weight: bold;">${assessment.ai_score}%</span></p>
                    <p><strong>Current Tech Level:</strong> ${assessment.current_tech || 'Not specified'}</p>
                    <p><strong>AI Experience:</strong> ${assessment.ai_experience || 'Not specified'}</p>
                    <p><strong>Budget Range:</strong> ${assessment.budget || 'Not specified'}</p>
                    <p><strong>Timeline:</strong> ${assessment.timeline || 'Not specified'}</p>
                    <p><strong>Assessment Date:</strong> ${new Date(assessment.created_at).toLocaleString()}</p>
                </div>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Business Challenges</h3>
                <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                    ${challenges}
                </div>
            </div>
            
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">AI Opportunities</h3>
                <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                    ${opportunities}
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                <button onclick="generateReportFromView(${assessment.id})" style="background: #4f46e5; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 1rem;">
                    üìÑ Generate Assessment Report
                </button>
                <button onclick="editAssessmentFromView(${assessment.id})" style="background: #f59e0b; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                    ‚úèÔ∏è Edit Assessment
                </button>
            </div>
        </div>
    `;
    
    document.getElementById('viewModalContent').innerHTML = content;
    document.getElementById('viewModal').style.display = 'block';
}

function deleteAssessment(id) {
    if (!confirm('Are you sure you want to delete this assessment?')) {
        return;
    }
    
    fetch('/api/delete_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Assessment deleted successfully!');
        } else {
            alert('Error deleting assessment: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error deleting assessment');
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function exportData() {
    if (assessments.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Create CSV content
    const headers = ['ID', 'Company', 'Contact', 'Email', 'Industry', 'AI Score', 'Created'];
    const csvContent = [
        headers.join(','),
        ...assessments.map(a => [
            a.id,
            `"${a.company_name}"`,
            `"${a.contact_name}"`,
            a.email,
            a.industry,
            a.ai_score,
            new Date(a.created_at).toISOString().split('T')[0]
        ].join(','))
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `assessments_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function confirmClearAll() {
    if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL assessment data permanently. Are you sure?')) {
        return;
    }
    
    fetch('/api/clear_all_assessments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('All assessment data has been cleared.');
        } else {
            alert('Error clearing data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error clearing data');
    });
}

function addSampleData() {
    if (!confirm('Add sample assessment data for testing?')) {
        return;
    }
    
    fetch('/api/add_sample_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Sample data added successfully!');
        } else {
            alert('Error adding sample data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error adding sample data');
    });
}

// Additional helper functions
function generateReportFromView(assessmentId) {
    if (!confirm('Generate Assessment Report ($750) for this assessment?')) {
        return;
    }
    
    // Show generating status
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '‚è≥ Generating Report...';
    button.disabled = true;
    
    // Generate the report
    fetch('/generate_report_from_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            assessment_id: assessmentId,
            report_type: 'assessment'
        })
    })
    .then(response => response.json())
    .then(result => {
        button.textContent = originalText;
        button.disabled = false;
        
    if (result.success) {
        // Create download link
        const a = document.createElement('a');
        a.href = result.download_url;
        a.download = result.download_url.split('/').pop();
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert('‚úÖ Assessment Report generated successfully!');
    } else {
        alert('‚ùå Error generating report: ' + result.error);
    }
    })
    .catch(error => {
        button.textContent = originalText;
        button.disabled = false;
        alert('‚ùå Network error generating report');
        console.error('Error:', error);
    });
}

function editAssessmentFromView(assessmentId) {
    closeModal('viewModal');
    editAssessment(assessmentId);
}

function editAssessment(id) {
    const assessment = assessments.find(a => a.id === id);
    if (!assessment) return;
    
    // Populate form fields
    document.getElementById('editId').value = assessment.id;
    document.getElementById('editCompanyName').value = assessment.company_name;
    document.getElementById('editIndustry').value = assessment.industry;
    document.getElementById('editFirstName').value = assessment.first_name || '';
    document.getElementById('editLastName').value = assessment.last_name || '';
    document.getElementById('editEmail').value = assessment.email;
    document.getElementById('editCompanySize').value = assessment.company_size || '';
    document.getElementById('editAiScore').value = assessment.ai_score;
    
    // Show modal
    document.getElementById('editModal').style.display = 'block';
}

function saveAssessment() {
    const formData = {
        id: document.getElementById('editId').value,
        company_name: document.getElementById('editCompanyName').value,
        industry: document.getElementById('editIndustry').value,
        first_name: document.getElementById('editFirstName').value,
        last_name: document.getElementById('editLastName').value,
        email: document.getElementById('editEmail').value,
        company_size: document.getElementById('editCompanySize').value,
        ai_score: document.getElementById('editAiScore').value
    };
    
    fetch('/api/update_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeModal('editModal');
            loadAssessments();
            alert('Assessment updated successfully!');
        } else {
            alert('Error updating assessment: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error updating assessment');
    });
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}
</script>
{% endblock %}