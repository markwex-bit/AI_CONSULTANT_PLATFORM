{% extends "base.html" %}
{% block title %}Admin Dashboard - AI Strategy Consultant{% endblock %}
{% block extra_head %}
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
<style>
    .admin-container {
        max-width: 1400px;
        margin: 2rem auto;
        background: white;
        border-radius: 12px;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.1);
    }
    
    .admin-header {
        background: linear-gradient(135deg, #dc2626, #b91c1c);
        color: white;
        padding: 2rem;
        text-align: center;
        border-radius: 12px 12px 0 0;
    }
    
    .admin-controls {
        padding: 2rem;
        background: #f8fafc;
        border-bottom: 1px solid #e5e7eb;
    }
    
    .controls-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }
    
    .control-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
    }
    
    .btn-refresh {
        background: #3b82f6;
        color: white;
    }
    
    .btn-export {
        background: #10b981;
        color: white;
    }
    
    .btn-clear {
        background: #ef4444;
        color: white;
    }
    
    .btn-trends {
        background: #8b5cf6;
        color: white;
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
        margin: 0;
    }
    
    .data-table th {
        background: #374151;
        color: white;
        padding: 12px 8px;
        text-align: left;
        font-weight: 600;
        font-size: 12px;
    }
    
    .data-table td {
        padding: 10px 8px;
        border-bottom: 1px solid #e5e7eb;
        font-size: 13px;
    }
    
    .data-table tr:hover {
        background: #f8fafc;
    }
    
    .action-buttons {
        display: flex;
        gap: 5px;
    }
    
    .action-btn {
        padding: 4px 8px;
        border: none;
        border-radius: 4px;
        font-size: 11px;
        font-weight: 600;
    }
    
    .form-source-badge {
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 10px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .form-source-assessment {
        background: #dbeafe;
        color: #1e40af;
    }
    
    .form-source-strategy {
        background: #fef3c7;
        color: #d97706;
    }
    
    .form-source-complete {
        background: #dcfce7;
        color: #166534;
    }
    
    .form-source-incomplete {
        background: #fee2e2;
        color: #dc2626;
    }
    
    .action-btn {
        cursor: pointer;
    }
    
    /* Database View Color-Coded Headers */
    .db-header-assessment {
        background: #dbeafe !important;
        color: #1e40af !important;
        font-weight: 700;
    }
    
    .db-header-strategy {
        background: #fef3c7 !important;
        color: #d97706 !important;
        font-weight: 700;
    }
    
    .db-header-common {
        background: #f3f4f6 !important;
        color: #374151 !important;
        font-weight: 700;
    }
    
    .db-view-legend {
        background: #f8fafc;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 16px;
        font-size: 12px;
    }
    
    .db-view-legend-item {
        display: inline-block;
        margin-right: 20px;
        font-weight: 600;
    }
    
    .db-view-legend-assessment {
        color: #1e40af;
    }
    
    .db-view-legend-strategy {
        color: #d97706;
    }
    
    .db-view-legend-common {
        color: #374151;
    }
    
    .btn-view {
        background: #3b82f6;
        color: white;
    }
    
    .btn-edit {
        background: #f59e0b;
        color: white;
    }
    
    .btn-delete {
        background: #ef4444;
        color: white;
    }
    
    .score-badge {
        background: #10b981;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 11px;
    }
    
    .table-container {
        overflow-x: auto;
        max-height: 600px;
        overflow-y: auto;
    }

    /* DB View styles */
    .dbview-container { padding: 1.5rem; border-top: 1px solid #e5e7eb; background: #fff; }
    .dbview-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.75rem; }
    .dbview-title { font-weight: 700; color: #374151; }
    .dbview-toggle { background: #111827; color: #fff; border: none; padding: 8px 12px; border-radius: 6px; font-weight: 600; cursor: pointer; }
    .dbview-scroll { border: 1px solid #e5e7eb; border-radius: 8px; overflow: auto; }
    .dbview-table { width: 100%; border-collapse: collapse; }
    .dbview-table thead th { position: sticky; top: 0; background: #111827; color: #fff; font-weight: 700; font-size: 12px; text-align: left; padding: 8px; border-bottom: 1px solid #111827; }
    .dbview-table tbody td { border-bottom: 1px solid #e5e7eb; padding: 6px 8px; font-size: 12px; max-width: 260px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .dbview-table tbody td.expanded { white-space: pre-wrap; overflow: visible; text-overflow: clip; max-width: none; word-break: break-word; }
    .dbview-table tbody tr:hover { background: #f9fafb; }
    .dbview-category { font-weight: 700; color: #111827; margin: 0.75rem 0 0.5rem 0; padding: 6px 10px; border-left: 4px solid #2563eb; background: #f3f4f6; border-radius: 6px; }
    
    .loading {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 9999;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }
    
    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 8px;
        width: 90%;
        max-width: 1200px;
        max-height: 90vh;
        overflow-y: auto;
        position: relative;
        z-index: 10000;
    }
    
    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }
    
    .close:hover {
        color: #000;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 8px 12px;
        border: 2px solid #e5e7eb;
        border-radius: 6px;
        font-size: 14px;
    }
    
    .form-group textarea {
        height: 80px;
        resize: vertical;
    }
    
    /* Trends Dashboard Styles */
    .trends-dashboard {
        display: none;
        padding: 2rem;
        background: #f8fafc;
    }
    
    .trends-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
    }
    
    .trend-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        border: 1px solid #e5e7eb;
    }
    
    .trend-card h3 {
        color: #374151;
        margin-bottom: 1rem;
        font-size: 1.1rem;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 0.5rem;
    }
    
    .metric {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: #f9fafb;
        border-radius: 6px;
    }
    
    .metric-label {
        font-weight: 600;
        color: #374151;
    }
    
    .metric-value {
        font-weight: bold;
        color: #059669;
    }
    
    .chart-container {
        height: 200px;
        margin-top: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6b7280;
        font-style: italic;
    }
    
    .industry-bar {
        background: #3b82f6;
        height: 20px;
        border-radius: 10px;
        margin: 0.25rem 0;
        position: relative;
        overflow: hidden;
    }
    
    .industry-bar-fill {
        background: linear-gradient(90deg, #3b82f6, #1d4ed8);
        height: 100%;
        border-radius: 10px;
        transition: width 0.3s ease;
    }
    
    .industry-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
    }
    
    .score-distribution {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1rem;
        margin-top: 1rem;
    }
    
    .score-range {
        text-align: center;
        padding: 1rem;
        border-radius: 8px;
        background: #f9fafb;
    }
    
    .score-range.high {
        background: #ecfdf5;
        border: 2px solid #10b981;
    }
    
    .score-range.medium {
        background: #fef3c7;
        border: 2px solid #f59e0b;
    }
    
    .score-range.low {
        background: #fef2f2;
        border: 2px solid #ef4444;
    }
    
    .score-number {
        font-size: 1.5rem;
        font-weight: bold;
        margin-bottom: 0.25rem;
    }
    
    .score-label {
        font-size: 0.8rem;
        color: #6b7280;
    }
    
    .tool-trends {
        margin-top: 1rem;
    }
    
    .tool-category {
        margin-bottom: 1rem;
        padding: 1rem;
        background: #f9fafb;
        border-radius: 8px;
        border-left: 4px solid #3b82f6;
    }
    
    .tool-category h4 {
        margin: 0 0 0.5rem 0;
        color: #374151;
        font-size: 1rem;
    }
    
    .tool-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.9rem;
    }
    
    .external-tool-indicator {
        color: #dc2626;
        font-weight: bold;
    }
</style>
{% endblock %}

{% block content %}
<div style="background: #f8fafc; min-height: 100vh; padding: 2rem 0;">
    <div class="admin-container">
        <div class="admin-header">
            <h1>üîß Admin Dashboard</h1>
            <p>Manage Client Assessments & Monitor Trends</p>
        </div>
        
        <div class="admin-controls">
            <div class="controls-grid">
                <button class="control-btn btn-refresh" onclick="loadAssessments()">
                    üîÑ Refresh Data
                </button>
                <button class="control-btn btn-export" onclick="exportData()">
                    üìä Export CSV
                </button>
                <button class="control-btn btn-trends" onclick="toggleTrends()">
                    üìà Monitoring Trends
                </button>
                <button class="control-btn btn-clear" onclick="confirmClearAll()">
                    üóëÔ∏è Clear All Data
                </button>
                <button class="control-btn" onclick="addSampleData()" style="background: #8b5cf6; color: white;">
                    ‚ûï Add Sample Data
                </button>
            </div>
        </div>
        
        <!-- Navigation Tabs -->
        <div class="admin-nav" style="background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
            <div style="display: flex; border-bottom: 1px solid #e5e7eb;">
                <button class="nav-tab active" onclick="showSection('assessments', event)" style="flex: 1; padding: 1rem; background: #fff; border: none; border-bottom: 3px solid #dc2626; color: #dc2626; font-weight: 600; cursor: pointer;">
                    üìã Client Assessments
                </button>
                <button class="nav-tab" onclick="showSection('formBuilder', event)" style="flex: 1; padding: 1rem; background: #f8fafc; border: none; color: #6b7280; font-weight: 600; cursor: pointer;">
                    üèóÔ∏è Dynamic Form Builder
                </button>
                <button class="nav-tab" onclick="showSection('database', event)" style="flex: 1; padding: 1rem; background: #f8fafc; border: none; color: #6b7280; font-weight: 600; cursor: pointer;">
                    üóÑÔ∏è Database View
                </button>
            </div>
        </div>
        
        <!-- Assessments Section -->
        <div id="assessmentsSection" class="content-section">
            <div class="table-container">
                <div id="loadingMessage" class="loading">
                    Loading assessment data...
                </div>
                <div id="batchControls" style="display: none; padding: 1rem; background: #f8fafc; border-bottom: 1px solid #e5e7eb;">
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            Select All
                        </label>
                        <span id="selectedCount" style="color: #6b7280;">0 selected</span>
                        <button id="batchDeleteBtn" class="control-btn btn-clear" onclick="batchDeleteAssessments()" disabled>
                            üóëÔ∏è Delete Selected
                        </button>
                    </div>
                </div>
                <table class="data-table" id="assessmentsTable" style="display: none;">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="headerSelectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>Company</th>
                            <th>Industry</th>
                            <th>Contact</th>
                            <th>AI Score</th>
                            <th>Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="assessmentsTableBody">
                        <!-- Assessment data will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Dynamic Form Builder Section -->
        <div id="formBuilderSection" class="content-section" style="display: none; padding: 2rem;">
            <div style="margin-bottom: 2rem;">
                <h2 style="color: #1f2937; margin-bottom: 1rem;">üèóÔ∏è Dynamic Form Builder</h2>
                <p style="color: #6b7280; margin-bottom: 1.5rem;">Configure form fields, sections, and options for both Assessment and Strategic Blueprint forms.</p>
                
                <!-- Form Filter -->
                <div style="margin-bottom: 2rem; padding: 1rem; background: #f3f4f6; border-radius: 8px;">
                    <h3 style="color: #374151; margin-bottom: 1rem;">Form Filter</h3>
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <select id="formFilter" onchange="filterFieldsByForm()" style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 6px; background: white;">
                            <option value="">All Forms</option>
                            <option value="A">Assessment Form</option>
                            <option value="S">Strategic Blueprint Form</option>
                        </select>
                        <button onclick="loadFormBuilder()" style="background: #3b82f6; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-weight: 500;">
                            üîÑ Refresh
                        </button>
                    </div>
                </div>
                
                <!-- Field Configurations Table -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #374151; margin-bottom: 1rem;">Field Configurations</h3>
                    <div id="fieldConfigTable" style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Field Name</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Label</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Type</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Section</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Form</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="fieldConfigTableBody">
                                <!-- Field configurations will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Section Configurations Table -->
                <div style="margin-bottom: 2rem;">
                    <h3 style="color: #374151; margin-bottom: 1rem;">Section Configurations</h3>
                    <div id="sectionConfigTable" style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Section Name</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Title</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Step</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Description</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="sectionConfigTableBody">
                                <!-- Section configurations will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Dropdown Options Table -->
                <div>
                    <h3 style="color: #374151; margin-bottom: 1rem;">Dropdown Options</h3>
                    <div id="dropdownOptionsTable" style="border: 1px solid #e5e7eb; border-radius: 8px; overflow: hidden;">
                        <table style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #f9fafb;">
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Field Name</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Value</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Label</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Order</th>
                                    <th style="padding: 12px; text-align: left; border-bottom: 1px solid #e5e7eb; font-weight: 600;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="dropdownOptionsTableBody">
                                <!-- Dropdown options will be populated here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Database View Section -->
        <div id="databaseSection" class="content-section" style="display: none;">
            <div class="dbview-container">
                <div class="dbview-header">
                    <h3 class="dbview-title">üóÑÔ∏è Database View</h3>
                    <button class="dbview-toggle" onclick="toggleDatabaseView(event)">Toggle Database View</button>
                </div>
                <div id="databaseView" class="dbview-scroll" style="display: none; max-height: 400px;">
                    <table class="dbview-table" id="databaseTable">
                        <thead id="dbViewHead">
                            <tr>
                                <th>Table</th>
                                <th>Column</th>
                                <th>Type</th>
                                <th>Description</th>
                            </tr>
                        </thead>
                        <tbody id="dbViewBody">
                            <!-- Database schema will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Trends Dashboard -->
        <div id="trendsDashboard" class="trends-dashboard">
            <div class="trends-grid">
                <!-- Assessment Overview -->
                <div class="trend-card">
                    <h3>üìä Assessment Overview</h3>
                    <div id="assessmentOverview">
                        <div class="metric">
                            <span class="metric-label">Total Assessments</span>
                            <span class="metric-value" id="totalAssessments">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">This Month</span>
                            <span class="metric-value" id="monthlyAssessments">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average AI Score</span>
                            <span class="metric-value" id="avgAiScore">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Reports Generated</span>
                            <span class="metric-value" id="reportsGenerated">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Industry Distribution -->
                <div class="trend-card">
                    <h3>üè≠ Industry Distribution</h3>
                    <div id="industryDistribution">
                        <!-- Industry data will be populated here -->
                    </div>
                </div>
                
                <!-- AI Score Distribution -->
                <div class="trend-card">
                    <h3>üéØ AI Score Distribution</h3>
                    <div class="score-distribution">
                        <div class="score-range high">
                            <div class="score-number" id="highScoreCount">-</div>
                            <div class="score-label">High (80-100)</div>
                        </div>
                        <div class="score-range medium">
                            <div class="score-number" id="mediumScoreCount">-</div>
                            <div class="score-label">Medium (50-79)</div>
                        </div>
                        <div class="score-range low">
                            <div class="score-number" id="lowScoreCount">-</div>
                            <div class="score-label">Low (0-49)</div>
                        </div>
                    </div>
                </div>
                
                <!-- Tool Recommendation Trends -->
                <div class="trend-card">
                    <h3>üõ†Ô∏è Tool Recommendation Trends</h3>
                    <div id="toolTrends" class="tool-trends">
                        <!-- Tool trends will be populated here -->
                    </div>
                </div>
                
                <!-- External Tools Analysis -->
                <div class="trend-card">
                    <h3>üîó External Tool Analysis</h3>
                    <div id="externalToolsAnalysis">
                        <div class="metric">
                            <span class="metric-label">External Tools Recommended</span>
                            <span class="metric-value" id="externalToolsCount">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Most Requested Category</span>
                            <span class="metric-value" id="mostRequestedCategory">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Portfolio Expansion Opportunities</span>
                            <span class="metric-value" id="expansionOpportunities">-</span>
                        </div>
                    </div>
                </div>
                
                <!-- Revenue Tracking -->
                <div class="trend-card">
                    <h3>üí∞ Revenue Tracking</h3>
                    <div id="revenueTracking">
                        <div class="metric">
                            <span class="metric-label">Total Revenue Potential</span>
                            <span class="metric-value" id="totalRevenuePotential">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Average Deal Size</span>
                            <span class="metric-value" id="avgDealSize">-</span>
                        </div>
                        <div class="metric">
                            <span class="metric-label">Conversion Rate</span>
                            <span class="metric-value" id="conversionRate">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- View Modal -->
<div id="viewModal" class="modal">
    <div class="modal-content" style="max-width: 900px;">
        <span class="close" onclick="closeModal('viewModal')">&times;</span>
        <h2>üìã Assessment Details</h2>
        <div id="viewModalContent">
            <!-- Assessment details will be loaded here -->
        </div>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content" style="max-width: 9%; max-height: 90vh; overflow-y: auto;">
        <span class="close" onclick="closeModal('editModal')">&times;</span>
        <h2>Edit Assessment</h2>
        <form id="editForm">
            <input type="hidden" id="editId">
            
            <!-- Basic Information -->
            <h3 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 1rem;">Basic Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="editCompanyName" required>
                </div>
                <div class="form-group">
                    <label>Industry</label>
                    <select id="editIndustry">
                        <option value="automotive">Automotive</option>
                        <option value="healthcare">Healthcare</option>
                        <option value="manufacturing">Manufacturing</option>
                        <option value="retail">Retail</option>
                        <option value="professional-services">Professional Services</option>
                        <option value="technology">Technology</option>
                        <option value="other">Other</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Company Size</label>
                    <select id="editCompanySize">
                        <option value="10-50">10-50 employees</option>
                        <option value="51-100">51-100 employees</option>
                        <option value="101-250">101-250 employees</option>
                        <option value="251-500">251-500 employees</option>
                        <option value="500+">500+ employees</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Role</label>
                    <input type="text" id="editRole">
                </div>
            </div>
            
            <div class="form-group">
                <label>Website</label>
                <input type="url" id="editWebsite">
            </div>
            
            <!-- Contact Information -->
            <h3 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 2rem;">Contact Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>First Name *</label>
                    <input type="text" id="editFirstName" required>
                </div>
                <div class="form-group">
                    <label>Last Name *</label>
                    <input type="text" id="editLastName" required>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="editEmail" required>
                </div>
                <div class="form-group">
                    <label>Phone</label>
                    <input type="tel" id="editPhone">
                </div>
            </div>
            
            <!-- Business Assessment -->
            <h3 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 2rem;">Business Assessment</h3>
            <div class="form-group">
                <label>Business Challenges</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editChallenge1" value="Customer service bottleneck"> Customer service bottleneck
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editChallenge2" value="Data management issues"> Data management issues
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editChallenge3" value="Process inefficiencies"> Process inefficiencies
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editChallenge4" value="Cost optimization"> Cost optimization
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editChallenge5" value="Competitive pressure"> Competitive pressure
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editChallenge6" value="Technology adoption"> Technology adoption
                    </label>
                </div>
                <input type="text" id="editChallengesOther" placeholder="Other challenges (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Current Tech Level</label>
                    <select id="editCurrentTech">
                        <option value="basic">Basic</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                        <option value="expert">Expert</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>AI Experience</label>
                    <select id="editAiExperience">
                        <option value="none">None</option>
                        <option value="basic">Basic</option>
                        <option value="intermediate">Intermediate</option>
                        <option value="advanced">Advanced</option>
                    </select>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Budget Range</label>
                    <select id="editBudget">
                        <option value="under-10k">Under $10K</option>
                        <option value="10k-50k">$10K - $50K</option>
                        <option value="50k-100k">$50K - $100K</option>
                        <option value="100k-500k">$100K - $500K</option>
                        <option value="500k+">$500K+</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Timeline</label>
                    <select id="editTimeline">
                        <option value="immediate">Immediate</option>
                        <option value="3-months">3 months</option>
                        <option value="6-months">6 months</option>
                        <option value="1-year">1 year</option>
                        <option value="flexible">Flexible</option>
                    </select>
                </div>
            </div>
            
            <!-- Enhanced Assessment Fields -->
            <h3 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 2rem;">Enhanced Assessment</h3>
            <div class="form-group">
                <label>Current Tools & Software</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTool1" value="CRM systems"> CRM systems
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTool2" value="ERP systems"> ERP systems
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTool3" value="Marketing automation"> Marketing automation
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTool4" value="Analytics platforms"> Analytics platforms
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTool5" value="Communication tools"> Communication tools
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTool6" value="Project management"> Project management
                    </label>
                </div>
                <input type="text" id="editCurrentToolsOther" placeholder="Other tools (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Tool Preferences</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPref1" value="Cloud-based solutions"> Cloud-based solutions
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPref2" value="On-premise solutions"> On-premise solutions
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPref3" value="Open source"> Open source
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPref4" value="Enterprise-grade"> Enterprise-grade
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPref5" value="User-friendly interfaces"> User-friendly interfaces
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPref6" value="Integration capabilities"> Integration capabilities
                    </label>
                </div>
                <input type="text" id="editToolPreferencesOther" placeholder="Other preferences (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Implementation Priority</label>
                    <select id="editImplementationPriority">
                        <option value="high">High</option>
                        <option value="medium">Medium</option>
                        <option value="low">Low</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Team Availability</label>
                    <select id="editTeamAvailability">
                        <option value="dedicated">Dedicated team</option>
                        <option value="part-time">Part-time</option>
                        <option value="limited">Limited</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Change Management Experience</label>
                <select id="editChangeManagementExperience">
                    <option value="extensive">Extensive</option>
                    <option value="moderate">Moderate</option>
                    <option value="limited">Limited</option>
                    <option value="none">None</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Data Governance</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editDataGov1" value="Data classification"> Data classification
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editDataGov2" value="Access controls"> Access controls
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editDataGov3" value="Data retention policies"> Data retention policies
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editDataGov4" value="Privacy compliance"> Privacy compliance
                    </label>
                </div>
                <input type="text" id="editDataGovernanceOther" placeholder="Other governance policies (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Security Requirements</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editSec1" value="Encryption"> Encryption
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editSec2" value="Multi-factor authentication"> Multi-factor authentication
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editSec3" value="Regular security audits"> Regular security audits
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editSec4" value="Compliance certifications"> Compliance certifications
                    </label>
                </div>
                <input type="text" id="editSecurityRequirementsOther" placeholder="Other security requirements (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Compliance Needs</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editComp1" value="GDPR"> GDPR
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editComp2" value="HIPAA"> HIPAA
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editComp3" value="SOX"> SOX
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editComp4" value="Industry-specific"> Industry-specific
                    </label>
                </div>
                <input type="text" id="editComplianceNeedsOther" placeholder="Other compliance needs (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Integration Requirements</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editInt1" value="API integration"> API integration
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editInt2" value="Database connectivity"> Database connectivity
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editInt3" value="Third-party systems"> Third-party systems
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editInt4" value="Legacy systems"> Legacy systems
                    </label>
                </div>
                <input type="text" id="editIntegrationRequirementsOther" placeholder="Other integration requirements (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Success Metrics</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMetric1" value="Cost reduction"> Cost reduction
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMetric2" value="Efficiency improvement"> Efficiency improvement
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMetric3" value="Customer satisfaction"> Customer satisfaction
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMetric4" value="Revenue growth"> Revenue growth
                    </label>
                </div>
                <input type="text" id="editSuccessMetricsOther" placeholder="Other success metrics (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Expected ROI</label>
                    <input type="text" id="editExpectedRoi">
                </div>
                <div class="form-group">
                    <label>Payback Period</label>
                    <input type="text" id="editPaybackPeriod">
                </div>
            </div>
            
            <div class="form-group">
                <label>Risk Factors</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRisk1" value="Data security"> Data security
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRisk2" value="Implementation complexity"> Implementation complexity
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRisk3" value="User adoption"> User adoption
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRisk4" value="Budget overruns"> Budget overruns
                    </label>
                </div>
                <input type="text" id="editRiskFactorsOther" placeholder="Other risk factors (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Mitigation Strategies</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMit1" value="Phased implementation"> Phased implementation
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMit2" value="Change management"> Change management
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMit3" value="Training programs"> Training programs
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editMit4" value="Pilot testing"> Pilot testing
                    </label>
                </div>
                <input type="text" id="editMitigationStrategiesOther" placeholder="Other mitigation strategies (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Implementation Phases</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPhase1" value="Planning & Analysis"> Planning & Analysis
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPhase2" value="Design & Development"> Design & Development
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPhase3" value="Testing & Validation"> Testing & Validation
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editPhase4" value="Deployment & Training"> Deployment & Training
                    </label>
                </div>
                <input type="text" id="editImplementationPhasesOther" placeholder="Other implementation phases (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Resource Requirements</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRes1" value="Technical expertise"> Technical expertise
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRes2" value="Project management"> Project management
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRes3" value="Training resources"> Training resources
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editRes4" value="Infrastructure"> Infrastructure
                    </label>
                </div>
                <input type="text" id="editResourceRequirementsOther" placeholder="Other resource requirements (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Training Needs</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTrain1" value="User training"> User training
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTrain2" value="Administrator training"> Administrator training
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTrain3" value="Technical training"> Technical training
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editTrain4" value="Process training"> Process training
                    </label>
                </div>
                <input type="text" id="editTrainingNeedsOther" placeholder="Other training needs (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Vendor Criteria</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendor1" value="Experience & track record"> Experience & track record
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendor2" value="Technical capabilities"> Technical capabilities
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendor3" value="Support & maintenance"> Support & maintenance
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendor4" value="Cost-effectiveness"> Cost-effectiveness
                    </label>
                </div>
                <input type="text" id="editVendorCriteriaOther" placeholder="Other vendor criteria (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <!-- Strategy Blueprint Fields -->
            <h3 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 2rem;">Strategy Blueprint</h3>
            <div class="form-group">
                <label>Competitors</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editCompetitor1" value="Direct competitors"> Direct competitors
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editCompetitor2" value="Indirect competitors"> Indirect competitors
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editCompetitor3" value="New market entrants"> New market entrants
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editCompetitor4" value="Substitute products"> Substitute products
                    </label>
                </div>
                <input type="text" id="editCompetitorsOther" placeholder="Other competitors (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Competitive Advantages</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editAdv1" value="Technology leadership"> Technology leadership
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editAdv2" value="Customer relationships"> Customer relationships
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editAdv3" value="Operational efficiency"> Operational efficiency
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editAdv4" value="Brand recognition"> Brand recognition
                    </label>
                </div>
                <input type="text" id="editCompetitiveAdvantagesOther" placeholder="Other competitive advantages (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Market Position</label>
                <select id="editMarketPosition">
                    <option value="leader">Market Leader</option>
                    <option value="challenger">Challenger</option>
                    <option value="follower">Follower</option>
                    <option value="niche">Niche</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Vendor Features</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendorFeat1" value="Scalability"> Scalability
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendorFeat2" value="Customization"> Customization
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendorFeat3" value="Integration capabilities"> Integration capabilities
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editVendorFeat4" value="Analytics & reporting"> Analytics & reporting
                    </label>
                </div>
                <input type="text" id="editVendorFeaturesOther" placeholder="Other vendor features (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Risk Tolerance</label>
                    <select id="editRiskTolerance">
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Risk Concerns</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editRiskConcern1" value="Data security"> Data security
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editRiskConcern2" value="Vendor lock-in"> Vendor lock-in
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editRiskConcern3" value="Implementation delays"> Implementation delays
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editRiskConcern4" value="Cost overruns"> Cost overruns
                        </label>
                    </div>
                    <input type="text" id="editRiskConcernsOther" placeholder="Other risk concerns (comma separated)" style="width: 100%; margin-top: 0.5rem;">
                </div>
            </div>
            
            <div class="form-group">
                <label>Organizational Structure</label>
                <select id="editOrgStructure">
                    <option value="centralized">Centralized</option>
                    <option value="decentralized">Decentralized</option>
                    <option value="hybrid">Hybrid</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Decision Process</label>
                <select id="editDecisionProcess">
                    <option value="autocratic">Autocratic</option>
                    <option value="democratic">Democratic</option>
                    <option value="consensus">Consensus</option>
                    <option value="consultative">Consultative</option>
                </select>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Team Size</label>
                    <input type="text" id="editTeamSize">
                </div>
                <div class="form-group">
                    <label>Skill Gaps</label>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editSkillGap1" value="Technical skills"> Technical skills
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editSkillGap2" value="Data analysis"> Data analysis
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editSkillGap3" value="Change management"> Change management
                        </label>
                        <label style="display: flex; align-items: center; font-size: 0.9rem;">
                            <input type="checkbox" id="editSkillGap4" value="Project management"> Project management
                        </label>
                    </div>
                    <input type="text" id="editSkillGapsOther" placeholder="Other skill gaps (comma separated)" style="width: 100%; margin-top: 0.5rem;">
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>Budget Allocation</label>
                    <input type="text" id="editBudgetAllocation">
                </div>
                <div class="form-group">
                    <label>ROI Timeline</label>
                    <input type="text" id="editRoiTimeline">
                </div>
            </div>
            
            <div class="form-group">
                <label>Current KPIs</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editKpi1" value="Revenue growth"> Revenue growth
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editKpi2" value="Customer satisfaction"> Customer satisfaction
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editKpi3" value="Operational efficiency"> Operational efficiency
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editKpi4" value="Cost reduction"> Cost reduction
                    </label>
                </div>
                <input type="text" id="editCurrentKpisOther" placeholder="Other KPIs (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <div class="form-group">
                <label>Improvement Goals</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 0.5rem; margin-bottom: 0.5rem;">
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editGoal1" value="Process automation"> Process automation
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editGoal2" value="Data-driven decisions"> Data-driven decisions
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editGoal3" value="Customer experience"> Customer experience
                    </label>
                    <label style="display: flex; align-items: center; font-size: 0.9rem;">
                        <input type="checkbox" id="editGoal4" value="Operational excellence"> Operational excellence
                    </label>
                </div>
                <input type="text" id="editImprovementGoalsOther" placeholder="Other improvement goals (comma separated)" style="width: 100%; margin-top: 0.5rem;">
            </div>
            
            <!-- System Fields -->
            <h3 style="color: #374151; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem; margin-top: 2rem;">System Information</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div class="form-group">
                    <label>AI Score</label>
                    <input type="number" id="editAiScore" min="0" max="100">
                </div>
                <div class="form-group">
                    <label>Report Type</label>
                    <select id="editReportType">
                        <option value="assessment">Assessment</option>
                        <option value="strategy">Strategy Blueprint</option>
                    </select>
                </div>
            </div>
            
            <div class="form-group">
                <label>Opportunities (JSON array)</label>
                <textarea id="editOpportunities" placeholder='[{"title": "Opportunity 1", "description": "Description", "roi": 25000}]'></textarea>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                        <button type="button" class="control-btn btn-refresh" onclick="saveAssessment()">
            üíæ Save Changes
        </button>
        <button type="button" class="control-btn" onclick="generateReportFromEdit()" style="background: #4f46e5; color: white;">
            üìÑ Generate New Report
        </button>
        <button type="button" class="control-btn" onclick="testModal()" style="background: #10b981; color: white;">
            üß™ Test Modal
        </button>
        <button type="button" class="control-btn" onclick="closeModal('editModal')" style="background: #6b7280; color: white;">
            ‚ùå Cancel
        </button>
            </div>
        </form>
    </div>
</div>

<script>
console.log('Admin page JavaScript loaded');
let assessments = [];
let trendsData = {};

// Load assessments when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMContentLoaded event fired');
    console.log('Calling loadAssessments...');
    loadAssessments();
    console.log('Calling loadDbRows...');
    // Preload DB rows in background
    loadDbRows();
});

function toggleTrends() {
    const trendsDashboard = document.getElementById('trendsDashboard');
    const button = event.target;
    
    if (trendsDashboard.style.display === 'none' || trendsDashboard.style.display === '') {
        trendsDashboard.style.display = 'block';
        button.textContent = 'üìä Hide Trends';
        button.style.background = '#6b7280';
        loadTrendsData();
    } else {
        trendsDashboard.style.display = 'none';
        button.textContent = 'üìà Monitoring Trends';
        button.style.background = '#8b5cf6';
    }
}

function loadTrendsData() {
    if (assessments.length === 0) {
        loadAssessments().then(() => {
            calculateTrends();
        });
    } else {
        calculateTrends();
    }
}

function calculateTrends() {
    // Assessment Overview
    const totalAssessments = assessments.length;
    const currentMonth = new Date().getMonth();
    const currentYear = new Date().getFullYear();
    const monthlyAssessments = assessments.filter(a => {
        const date = new Date(a.created_at);
        return date.getMonth() === currentMonth && date.getFullYear() === currentYear;
    }).length;
    
    const avgAiScore = assessments.length > 0 ? 
        Math.round(assessments.reduce((sum, a) => sum + a.ai_score, 0) / assessments.length) : 0;
    
    // AI Score Distribution
    const highScores = assessments.filter(a => a.ai_score >= 80).length;
    const mediumScores = assessments.filter(a => a.ai_score >= 50 && a.ai_score < 80).length;
    const lowScores = assessments.filter(a => a.ai_score < 50).length;
    
    // Industry Distribution
    const industryCounts = {};
    assessments.forEach(a => {
        industryCounts[a.industry] = (industryCounts[a.industry] || 0) + 1;
    });
    
    // Tool Trends Analysis
    const toolCategories = ['customer_service', 'workflow_automation', 'development', 'business_intelligence'];
    const toolTrends = {};
    let externalToolsCount = 0;
    let externalToolCategories = {};
    
    assessments.forEach(assessment => {
        if (assessment.opportunities && Array.isArray(assessment.opportunities)) {
            assessment.opportunities.forEach(opp => {
                if (opp.solutions && Array.isArray(opp.solutions)) {
                    opp.solutions.forEach(sol => {
                        if (sol.type === 'External') {
                            externalToolsCount++;
                            const category = opp.category || 'unknown';
                            externalToolCategories[category] = (externalToolCategories[category] || 0) + 1;
                        }
                    });
                }
            });
        }
    });
    
    // Revenue Tracking
    const totalRevenuePotential = totalAssessments * 750; // $750 per assessment report
    const avgDealSize = 750;
    const conversionRate = totalAssessments > 0 ? Math.round((monthlyAssessments / totalAssessments) * 100) : 0;
    
    // Update UI
    document.getElementById('totalAssessments').textContent = totalAssessments;
    document.getElementById('monthlyAssessments').textContent = monthlyAssessments;
    document.getElementById('avgAiScore').textContent = avgAiScore + '%';
    document.getElementById('reportsGenerated').textContent = totalAssessments; // Assuming 1 report per assessment
    
    document.getElementById('highScoreCount').textContent = highScores;
    document.getElementById('mediumScoreCount').textContent = mediumScores;
    document.getElementById('lowScoreCount').textContent = lowScores;
    
    document.getElementById('externalToolsCount').textContent = externalToolsCount;
    document.getElementById('mostRequestedCategory').textContent = 
        Object.keys(externalToolCategories).length > 0 ? 
        Object.keys(externalToolCategories).reduce((a, b) => 
            externalToolCategories[a] > externalToolCategories[b] ? a : b) : 'None';
    document.getElementById('expansionOpportunities').textContent = 
        Object.keys(externalToolCategories).length;
    
    document.getElementById('totalRevenuePotential').textContent = '$' + totalRevenuePotential.toLocaleString();
    document.getElementById('avgDealSize').textContent = '$' + avgDealSize.toLocaleString();
    document.getElementById('conversionRate').textContent = conversionRate + '%';
    
    // Render Industry Distribution
    renderIndustryDistribution(industryCounts);
    
    // Render Tool Trends
    renderToolTrends(externalToolCategories);
}

function renderIndustryDistribution(industryCounts) {
    const container = document.getElementById('industryDistribution');
    const total = Object.values(industryCounts).reduce((sum, count) => sum + count, 0);
    
    let html = '';
    Object.entries(industryCounts)
        .sort(([,a], [,b]) => b - a)
        .forEach(([industry, count]) => {
            const percentage = Math.round((count / total) * 100);
            const displayName = industry.charAt(0).toUpperCase() + industry.slice(1).replace('-', ' ');
            
            html += `
                <div class="industry-label">
                    <span>${displayName}</span>
                    <span>${count} (${percentage}%)</span>
                </div>
                <div class="industry-bar">
                    <div class="industry-bar-fill" style="width: ${percentage}%"></div>
                </div>
            `;
        });
    
    container.innerHTML = html;
}

function renderToolTrends(externalToolCategories) {
    const container = document.getElementById('toolTrends');
    
    if (Object.keys(externalToolCategories).length === 0) {
        container.innerHTML = '<p style="color: #6b7280; text-align: center; font-style: italic;">No external tools recommended yet</p>';
        return;
    }
    
    let html = '';
    Object.entries(externalToolCategories)
        .sort(([,a], [,b]) => b - a)
        .forEach(([category, count]) => {
            const displayName = category.charAt(0).toUpperCase() + category.slice(1).replace('_', ' ');
            
            html += `
                <div class="tool-category">
                    <h4>${displayName}</h4>
                    <div class="tool-stats">
                        <span>External Tools: <span class="external-tool-indicator">${count}</span></span>
                        <span>Portfolio Gap: High</span>
                    </div>
                </div>
            `;
        });
    
    container.innerHTML = html;
}

function loadAssessments() {
    console.log('Loading assessments...');
    console.log('loadingMessage element:', document.getElementById('loadingMessage'));
    console.log('assessmentsTable element:', document.getElementById('assessmentsTable'));
    console.log('batchControls element:', document.getElementById('batchControls'));
    
    document.getElementById('loadingMessage').style.display = 'block';
    document.getElementById('assessmentsTable').style.display = 'none';
    document.getElementById('batchControls').style.display = 'block';
    
    // Add cache-busting parameter
    const url = '/api/assessments?t=' + Date.now();
    console.log('Fetching from:', url);
    
    return fetch(url)
        .then(response => {
            console.log('Response status:', response.status);
            console.log('Response headers:', response.headers);
            return response.json();
        })
        .then(data => {
            console.log('Response data:', data);
            console.log('Hiding loading message...');
            document.getElementById('loadingMessage').style.display = 'none';
            
            if (data.success) {
                assessments = data.assessments;
                console.log('Assessments loaded:', assessments.length);
                console.log('Calling displayAssessments...');
                displayAssessments(assessments);
                console.log('Showing assessments table...');
                document.getElementById('assessmentsTable').style.display = 'table';
            } else {
                console.error('API error:', data.error);
                document.getElementById('loadingMessage').innerHTML = 'Error loading data: ' + (data.error || 'Unknown error');
            }
        })
        .catch(error => {
            console.error('Network error:', error);
            document.getElementById('loadingMessage').innerHTML = 'Network error loading assessments';
        });
}

// ---- DB View ----
let dbRows = [];
let dbColumns = [];

function toggleDbView() {
    const content = document.getElementById('dbViewContent');
    const btn = document.getElementById('dbViewToggle');
    const isHidden = content.style.display === 'none' || content.style.display === '';
    if (isHidden) {
        content.style.display = 'block';
        btn.textContent = 'Hide';
        if (dbRows.length === 0) {
            loadDbRows();
        }
    } else {
        content.style.display = 'none';
        btn.textContent = 'Show';
    }
}

function loadDbRows() {
    fetch('/api/db_view')
        .then(r => r.json())
        .then(d => {
            if (d && d.success) {
                dbRows = d.rows || [];
                dbColumns = computeOrderedColumns(dbRows);
                renderDbTable(dbRows, dbColumns);
            } else {
                renderDbError(d && d.error ? d.error : 'Unknown error');
            }
        })
        .catch(() => renderDbError('Network error'));
}

function renderDbError(msg) {
    const thead = document.getElementById('dbViewHead');
    const tbody = document.getElementById('dbViewBody');
    if (!thead || !tbody) return;
    thead.innerHTML = '';
    tbody.innerHTML = `<tr><td style="padding:10px; color:#b91c1c;">Error: ${msg}</td></tr>`;
}

// Field mapping for form source identification
function getFieldFormSource(fieldName) {
    const assessmentFields = [
        'company_name', 'industry', 'company_size', 'role', 'website',
        'first_name', 'last_name', 'email', 'phone',
        'challenges', 'current_tech', 'ai_experience', 'budget', 'timeline',
        'current_tools', 'tool_preferences', 'implementation_priority',
        'team_availability', 'change_management_experience', 'data_governance',
        'security_requirements', 'compliance_needs', 'integration_requirements',
        'success_metrics', 'expected_roi', 'payback_period', 'risk_factors',
        'mitigation_strategies', 'implementation_phases', 'resource_requirements',
        'training_needs', 'vendor_criteria', 'pilot_project',
        'scalability_requirements', 'maintenance_plan', 'ai_score', 'opportunities'
    ];
    
    const strategyFields = [
        'competitors', 'competitive_advantages', 'market_position',
        'vendor_features', 'risk_tolerance', 'risk_concerns',
        'org_structure', 'decision_process', 'team_size', 'skill_gaps',
        'budget_allocation', 'roi_timeline', 'current_kpis', 'improvement_goals'
    ];
    
    const commonFields = [
        'id', 'created_at', 'form_source', 'assessment_completed_at', 
        'strategy_completed_at'
    ];
    
    if (assessmentFields.includes(fieldName)) {
        return 'assessment';
    } else if (strategyFields.includes(fieldName)) {
        return 'strategy';
    } else if (commonFields.includes(fieldName)) {
        return 'common';
    } else {
        return 'common'; // Default to common for unknown fields
    }
}

function renderDbTable(rows, columns) {
    const thead = document.getElementById('dbViewHead');
    const tbody = document.getElementById('dbViewBody');
    if (!thead || !tbody) return;

    if (!columns || columns.length === 0) {
        thead.innerHTML = '';
        tbody.innerHTML = `<tr><td style="padding:10px; color:#6b7280;">No rows</td></tr>`;
        return;
    }

    // Create headers with color coding based on form source
    const headerCells = columns.map(column => {
        const formSource = getFieldFormSource(column);
        const cssClass = `db-header-${formSource}`;
        return `<th class="${cssClass}" title="Click cells to expand/collapse">${column}</th>`;
    });
    
    thead.innerHTML = `<tr>${headerCells.join('')}</tr>`;

    if (!rows || rows.length === 0) {
        tbody.innerHTML = `<tr><td colspan="${columns.length}" style="padding:10px; color:#6b7280;">Database is empty</td></tr>`;
        return;
    }

    tbody.innerHTML = rows.map(r => {
        const tds = columns.map(col => {
            let val = r[col];
            if (val === null || val === undefined) val = '';
            if (col === 'created_at') {
                try { val = formatDateEST(val); } catch (e) {}
            }
            if (typeof val === 'object') {
                try { val = JSON.stringify(val); } catch(e) { val = String(val); }
            }
            const safe = String(val).replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return `<td title="${safe}" onclick="toggleCellExpand(event)">${safe}</td>`;
        }).join('');
        return `<tr>${tds}</tr>`;
    }).join('');
}

function toggleCellExpand(ev) {
    const td = ev.currentTarget;
    if (!td) return;
    td.classList.toggle('expanded');
}

function formatDateEST(input) {
    if (!input) return '';
    try {
        let d;
        if (typeof input === 'number') {
            d = new Date(input);
        } else {
            const s = String(input);
            if (s.includes('T') || s.endsWith('Z')) {
                d = new Date(s);
            } else if (/^\d{4}-\d{2}-\d{2}/.test(s)) {
                // Treat naive date/time as UTC then display in EST
                d = new Date(s.replace(' ', 'T') + 'Z');
            } else {
                d = new Date(s);
            }
        }
        const parts = new Intl.DateTimeFormat('en-US', {
            timeZone: 'America/New_York',
            year: 'numeric', month: '2-digit', day: '2-digit',
            hour: 'numeric', minute: '2-digit', hour12: true
        }).formatToParts(d);
        const mm = parts.find(p => p.type === 'month')?.value || '';
        const dd = parts.find(p => p.type === 'day')?.value || '';
        const yyyy = parts.find(p => p.type === 'year')?.value || '';
        const hour = parts.find(p => p.type === 'hour')?.value || '';
        const minute = parts.find(p => p.type === 'minute')?.value || '';
        const dayPeriod = (parts.find(p => p.type === 'dayPeriod')?.value || '').toLowerCase();
        return `${mm}/${dd}/${yyyy} ${hour}:${minute} ${dayPeriod}`;
    } catch (e) {
        return String(input);
    }
}

// Define desired assessment form column order
function computeOrderedColumns(rows) {
    if (!rows || rows.length === 0) return [];
    const preferred = [
        // Identifiers & meta
        'id','created_at','report_type',
        // Company & contact
        'company_name','industry','company_size','role','website',
        'first_name','last_name','email','phone',
        // Core assessment selections
        'challenges','current_tech','ai_experience','budget','timeline',
        // Enhanced assessment arrays
        'current_tools','tool_preferences','implementation_priority',
        'team_availability','change_management_experience','data_governance',
        'security_requirements','compliance_needs','integration_requirements',
        'success_metrics','expected_roi','payback_period',
        'risk_factors','mitigation_strategies','implementation_phases',
        'resource_requirements','training_needs','vendor_criteria',
        'pilot_project','scalability_requirements','maintenance_plan',
        // Scores & computed
        'ai_score','opportunities',
        // Strategy blueprint (if present)
        'competitors','competitive_advantages','market_position','vendor_features',
        'risk_tolerance','risk_concerns','org_structure','decision_process',
        'team_size','skill_gaps','budget_allocation','roi_timeline',
        'current_kpis','improvement_goals'
    ];

    const present = Object.keys(rows[0] || {});
    const ordered = [];
    preferred.forEach(col => { if (present.includes(col)) ordered.push(col); });
    // Append any remaining columns not in preferred list
    present.forEach(col => { if (!ordered.includes(col)) ordered.push(col); });
    return ordered;
}

// Helper functions for form source display
function getFormSourceClass(assessment) {
    if (assessment.assessment_completed_at && assessment.strategy_completed_at) {
        return 'form-source-complete';
    } else if (assessment.assessment_completed_at) {
        return 'form-source-assessment';
    } else if (assessment.strategy_completed_at) {
        return 'form-source-strategy';
    } else {
        return 'form-source-incomplete';
    }
}

function getFormSourceText(assessment) {
    if (assessment.assessment_completed_at && assessment.strategy_completed_at) {
        return 'Complete';
    } else if (assessment.assessment_completed_at) {
        return 'Assessment';
    } else if (assessment.strategy_completed_at) {
        return 'Strategy';
    } else {
        return 'Incomplete';
    }
}

function getFormSourceTooltip(assessment) {
    if (assessment.assessment_completed_at && assessment.strategy_completed_at) {
        return `Both forms completed\nAssessment: ${new Date(assessment.assessment_completed_at).toLocaleDateString()}\nStrategy: ${new Date(assessment.strategy_completed_at).toLocaleDateString()}`;
    } else if (assessment.assessment_completed_at) {
        return `Assessment form completed on ${new Date(assessment.assessment_completed_at).toLocaleDateString()}`;
    } else if (assessment.strategy_completed_at) {
        return `Strategy form completed on ${new Date(assessment.strategy_completed_at).toLocaleDateString()}`;
    } else {
        return 'No forms completed yet';
    }
}

function displayAssessments(assessmentList) {
    console.log('displayAssessments called with:', assessmentList);
    const tbody = document.getElementById('assessmentsTableBody');
    console.log('tbody element:', tbody);
    tbody.innerHTML = '';
    
    if (assessmentList.length === 0) {
        console.log('No assessments to display');
        tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; padding: 2rem; color: #6b7280;">No assessments found</td></tr>';
        return;
    }
    
    console.log('Displaying', assessmentList.length, 'assessments');
    assessmentList.forEach((assessment, index) => {
        console.log('Creating row for assessment', index + 1, ':', assessment);
        const row = document.createElement('tr');
        const createdDate = new Date(assessment.created_at).toLocaleDateString();
        
        row.innerHTML = `
        <td><input type="checkbox" value="${assessment.id}" onchange="toggleBatchDeleteButton()"></td>
        <td>${assessment.company_name}</td>
        <td>${assessment.industry}</td>
        <td>${assessment.contact_name}</td>
        <td><span class="score-badge">${assessment.ai_score}%</span></td>
        <td>${createdDate}</td>
        <td>
            <div class="action-buttons">
                <button class="action-btn btn-view" onclick="viewAssessment(${assessment.id})" title="View Details">üëÅÔ∏è</button>
                <button class="action-btn btn-edit" onclick="editAssessment(${assessment.id})" title="Edit">‚úèÔ∏è</button>
            </div>
        </td>
`;
        
        tbody.appendChild(row);
        console.log('Row added to tbody');
    });
    console.log('displayAssessments completed');
}

function viewAssessment(id) {
    // Fetch complete assessment data from API
    fetch(`/api/assessment/${id}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                alert('Error loading assessment details: ' + data.error);
                return;
            }
            
            const assessment = data.assessment;
            
            // Helper function to format arrays
            function formatArray(arr, defaultText = 'None specified') {
                if (!Array.isArray(arr) || arr.length === 0) return defaultText;
                return arr.join(', ');
            }
    
    // Format challenges and opportunities
    const challenges = formatArray(assessment.challenges);
    let opportunities = 'None identified';
    if (Array.isArray(assessment.opportunities) && assessment.opportunities.length > 0) {
        opportunities = assessment.opportunities.map((opp, index) => 
            `<div style="margin-bottom: 1rem; padding: 1rem; background: white; border-radius: 6px; border-left: 3px solid #10b981;">
                <strong>${index + 1}. ${opp.title || 'Unnamed Opportunity'}</strong><br>
                <span style="color: #6b7280; font-size: 13px;">${opp.description || 'No description available'}</span><br>
                ${opp.roi ? `<span style="color: #059669; font-weight: 600;">Estimated ROI: $${opp.roi.toLocaleString()}</span>` : ''}
            </div>`
        ).join('');
    }
    
    const content = `
        <div style="line-height: 1.8; font-size: 14px; max-height: 80vh; overflow-y: auto;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                <div>
                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Company Information</h3>
                    <p><strong>Company Name:</strong> ${assessment.company_name || 'Not specified'}</p>
                    <p><strong>Industry:</strong> ${assessment.industry || 'Not specified'}</p>
                    <p><strong>Company Size:</strong> ${assessment.company_size || 'Not specified'}</p>
                    <p><strong>Website:</strong> ${assessment.website || 'Not provided'}</p>
                    <p><strong>Primary Contact:</strong> ${assessment.first_name || ''} ${assessment.last_name || ''}</p>
                    <p><strong>Role:</strong> ${assessment.role || 'Not specified'}</p>
                    <p><strong>Email:</strong> ${assessment.email || 'Not provided'}</p>
                    <p><strong>Phone:</strong> ${assessment.phone || 'Not provided'}</p>
                </div>
                
                <div>
                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">AI Readiness Assessment</h3>
                    <p><strong>AI Score:</strong> <span style="background: #10b981; color: white; padding: 4px 12px; border-radius: 16px; font-weight: bold;">${assessment.ai_score || 0}%</span></p>
                    <p><strong>Current Tech Level:</strong> ${assessment.current_tech || 'Not specified'}</p>
                    <p><strong>AI Experience:</strong> ${assessment.ai_experience || 'Not specified'}</p>
                    <p><strong>Budget Range:</strong> ${assessment.budget || 'Not specified'}</p>
                    <p><strong>Timeline:</strong> ${assessment.timeline || 'Not specified'}</p>
                    <p><strong>Assessment Date:</strong> ${new Date(assessment.created_at).toLocaleString()}</p>
                </div>
            </div>
            
                                            <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Business Challenges</h3>
                                    <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; border-left: 4px solid #f59e0b;">
                                        ${challenges}
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">AI Opportunities</h3>
                                    <div style="background: #ecfdf5; padding: 1rem; border-radius: 8px; border-left: 4px solid #10b981;">
                                        ${opportunities}
                                    </div>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Current Tools & Software</h3>
                                    <p><strong>Current Tools:</strong> ${formatArray(assessment.current_tools)}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Tool Preferences</h3>
                                    <p><strong>Tool Preferences:</strong> ${formatArray(assessment.tool_preferences)}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Implementation Priority</h3>
                                    <p><strong>Implementation Priority:</strong> ${formatArray(assessment.implementation_priority)}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Team & Resources</h3>
                                    <p><strong>Team Availability:</strong> ${assessment.team_availability || 'Not specified'}</p>
                                    <p><strong>Change Management Experience:</strong> ${assessment.change_management_experience || 'Not specified'}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Security & Compliance</h3>
                                    <p><strong>Security Requirements:</strong> ${formatArray(assessment.security_requirements)}</p>
                                    <p><strong>Compliance Needs:</strong> ${formatArray(assessment.compliance_needs)}</p>
                                    <p><strong>Data Governance:</strong> ${assessment.data_governance || 'Not specified'}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Integration Requirements</h3>
                                    <p><strong>Integration Requirements:</strong> ${formatArray(assessment.integration_requirements)}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Success Metrics</h3>
                                    <p><strong>Success Metrics:</strong> ${formatArray(assessment.success_metrics)}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Risk Assessment</h3>
                                    <p><strong>Risk Factors:</strong> ${formatArray(assessment.risk_factors)}</p>
                                    <p><strong>Mitigation Strategies:</strong> ${formatArray(assessment.mitigation_strategies)}</p>
                                </div>
                                
                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Implementation Planning</h3>
                                    <p><strong>Implementation Phases:</strong> ${formatArray(assessment.implementation_phases)}</p>
                                    <p><strong>Resource Requirements:</strong> ${formatArray(assessment.resource_requirements)}</p>
                                    <p><strong>Training Needs:</strong> ${formatArray(assessment.training_needs)}</p>
                                </div>
                                
                                                                <div style="margin-bottom: 2rem;">
                                    <h3 style="color: #374151; margin-bottom: 1rem; border-bottom: 2px solid #e5e7eb; padding-bottom: 0.5rem;">Vendor Selection</h3>
                                    <p><strong>Vendor Criteria:</strong> ${formatArray(assessment.vendor_criteria)}</p>
                                    <p><strong>Pilot Project Preference:</strong> ${assessment.pilot_project || 'Not specified'}</p>
                                    <p><strong>Scalability Requirements:</strong> ${assessment.scalability_requirements || 'Not specified'}</p>
                                    <p><strong>Maintenance Plan Preference:</strong> ${assessment.maintenance_plan || 'Not specified'}</p>
                                </div>
            
                                            <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #e5e7eb;">
                                    <button onclick="viewExistingReports(${assessment.id})" style="background: #10b981; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 1rem;">
                                        üìã View Existing Reports
                                    </button>
                                    <button onclick="generateAssessmentReportFromView(${assessment.id})" style="background: #4f46e5; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 1rem;">
                                        üìä Generate Assessment Report
                                    </button>
                                    <button onclick="generateStrategyReportFromView(${assessment.id})" style="background: #059669; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; margin-right: 1rem;">
                                        üéØ Generate Strategic Blueprint Report
                                    </button>
                                    <button onclick="editAssessmentFromView(${assessment.id})" style="background: #f59e0b; color: white; padding: 8px 16px; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
                                        ‚úèÔ∏è Edit Assessment
                                    </button>
                                </div>
        </div>
    `;
    
    document.getElementById('viewModalContent').innerHTML = content;
    document.getElementById('viewModal').style.display = 'block';
        })
        .catch(error => {
            console.error('Error fetching assessment details:', error);
            alert('Error loading assessment details. Please try again.');
        });
}

function deleteAssessment(id) {
    if (!confirm('Are you sure you want to delete this assessment?')) {
        return;
    }
    
    fetch('/api/delete_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Assessment deleted successfully!');
        } else {
            alert('Error deleting assessment: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error deleting assessment');
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function exportData() {
    if (assessments.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Create CSV content
    const headers = ['ID', 'Company', 'Contact', 'Email', 'Industry', 'AI Score', 'Created'];
    const csvContent = [
        headers.join(','),
        ...assessments.map(a => [
            a.id,
            `"${a.company_name}"`,
            `"${a.contact_name}"`,
            a.email,
            a.industry,
            a.ai_score,
            new Date(a.created_at).toISOString().split('T')[0]
        ].join(','))
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `assessments_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function confirmClearAll() {
    if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL assessment data permanently. Are you sure?')) {
        return;
    }
    
    fetch('/api/clear_all_assessments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('All assessment data has been cleared.');
        } else {
            alert('Error clearing data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error clearing data');
    });
}

function addSampleData() {
    if (!confirm('Add sample assessment data for testing?')) {
        return;
    }
    
    fetch('/api/add_sample_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Sample data added successfully!');
        } else {
            alert('Error adding sample data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error adding sample data');
    });
}

// Helper function to collect checkbox values
function collectCheckboxValues(checkboxPrefix, otherFieldId) {
    const values = [];
    document.querySelectorAll(`[id^="${checkboxPrefix}"]`).forEach(checkbox => {
        if (checkbox.checked) {
            values.push(checkbox.value);
        }
    });
    
    const otherValue = document.getElementById(otherFieldId).value.trim();
    if (otherValue) {
        values.push(...otherValue.split(',').map(item => item.trim()).filter(item => item));
    }
    
    return JSON.stringify(values);
}

// Additional helper functions
function viewExistingReports(assessmentId) {
    // Fetch existing reports for this assessment
    fetch(`/list_reports/${assessmentId}`)
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                if (result.reports && result.reports.length > 0) {
                    // Create a list of reports
                    let reportList = 'Available Reports:\n\n';
                    result.reports.forEach((report, index) => {
                        reportList += `${index + 1}. ${report}\n`;
                    });
                    
                    // Ask user which report to view
                    const reportIndex = prompt(reportList + '\nEnter the number of the report to view (or cancel to close):');
                    if (reportIndex && !isNaN(reportIndex)) {
                        const selectedReport = result.reports[parseInt(reportIndex) - 1];
                        if (selectedReport) {
                            window.open(`/view_report/${selectedReport}`, '_blank');
                        }
                    }
                } else {
                    alert('No existing reports found for this assessment.');
                }
            } else {
                alert('Error loading reports: ' + result.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error loading reports');
        });
}

function generateReportFromView(assessmentId) {
    if (!confirm('Generate a new HTML report for this assessment?')) {
        return;
    }
    
    // Show generating status
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '‚è≥ Generating Report...';
    button.disabled = true;
    
    // Generate the report
    fetch('/generate_report_from_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assessment_id: assessmentId })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Open the report in a new window
            window.open(result.view_url, '_blank');
            alert('Report generated successfully!');
        } else {
            alert('Error generating report: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating report');
    })
    .finally(() => {
        // Restore button
        button.textContent = originalText;
        button.disabled = false;
    });
}

function editAssessmentFromView(assessmentId) {
    closeModal('viewModal');
    editAssessment(assessmentId);
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

function deleteAssessment(id) {
    if (!confirm('Are you sure you want to delete this assessment?')) {
        return;
    }
    
    fetch('/api/delete_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: id })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Assessment deleted successfully!');
        } else {
            alert('Error deleting assessment: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error deleting assessment');
    });
}

function closeModal(modalId) {
    document.getElementById(modalId).style.display = 'none';
}

function exportData() {
    if (assessments.length === 0) {
        alert('No data to export');
        return;
    }
    
    // Create CSV content
    const headers = ['ID', 'Company', 'Contact', 'Email', 'Industry', 'AI Score', 'Created'];
    const csvContent = [
        headers.join(','),
        ...assessments.map(a => [
            a.id,
            `"${a.company_name}"`,
            `"${a.contact_name}"`,
            a.email,
            a.industry,
            a.ai_score,
            new Date(a.created_at).toISOString().split('T')[0]
        ].join(','))
    ].join('\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `assessments_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
}

function confirmClearAll() {
    if (!confirm('‚ö†Ô∏è WARNING: This will delete ALL assessment data permanently. Are you sure?')) {
        return;
    }
    
    fetch('/api/clear_all_assessments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('All assessment data has been cleared.');
        } else {
            alert('Error clearing data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error clearing data');
    });
}

function addSampleData() {
    if (!confirm('Add sample assessment data for testing?')) {
        return;
    }
    
    fetch('/api/add_sample_data', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            loadAssessments();
            alert('Sample data added successfully!');
        } else {
            alert('Error adding sample data: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error adding sample data');
    });
}

function editAssessment(id) {
    console.log('editAssessment called with id:', id);
    
    // Fetch complete assessment data from API
    fetch(`/api/assessment/${id}`)
        .then(response => response.json())
        .then(data => {
            if (!data.success) {
                console.error('Error fetching assessment:', data.error);
                alert('Error loading assessment data: ' + data.error);
                return;
            }
            
            const assessment = data.assessment;
            console.log('Found assessment:', assessment);
            
            // Populate basic form fields
            document.getElementById('editId').value = assessment.id;
            document.getElementById('editCompanyName').value = assessment.company_name || '';
            document.getElementById('editIndustry').value = assessment.industry || '';
            document.getElementById('editCompanySize').value = assessment.company_size || '';
            document.getElementById('editRole').value = assessment.role || '';
            document.getElementById('editWebsite').value = assessment.website || '';
            document.getElementById('editFirstName').value = assessment.first_name || '';
            document.getElementById('editLastName').value = assessment.last_name || '';
            document.getElementById('editEmail').value = assessment.email || '';
            document.getElementById('editPhone').value = assessment.phone || '';
            document.getElementById('editCurrentTech').value = assessment.current_tech || '';
            document.getElementById('editAiExperience').value = assessment.ai_experience || '';
            document.getElementById('editBudget').value = assessment.budget || '';
            document.getElementById('editTimeline').value = assessment.timeline || '';
            document.getElementById('editImplementationPriority').value = assessment.implementation_priority || '';
            document.getElementById('editTeamAvailability').value = assessment.team_availability || '';
            document.getElementById('editChangeManagementExperience').value = assessment.change_management_experience || '';
            document.getElementById('editAiScore').value = assessment.ai_score || '';
            document.getElementById('editReportType').value = assessment.report_type || 'assessment';
            
            // Handle challenges checkboxes - database values now match form values exactly
            let challenges = [];
            if (Array.isArray(assessment.challenges)) {
                challenges = assessment.challenges;
            } else if (typeof assessment.challenges === 'string') {
                try {
                    challenges = JSON.parse(assessment.challenges);
                } catch (e) {
                    challenges = assessment.challenges.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            
            document.querySelectorAll('[id^="editChallenge"]').forEach(checkbox => {
                checkbox.checked = challenges.includes(checkbox.value);
            });
            
            // Handle current tools checkboxes - database values now match form values exactly
            let currentTools = [];
            if (Array.isArray(assessment.current_tools)) {
                currentTools = assessment.current_tools;
            } else if (typeof assessment.current_tools === 'string') {
                try {
                    currentTools = JSON.parse(assessment.current_tools);
                } catch (e) {
                    currentTools = assessment.current_tools.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            
            document.querySelectorAll('[id^="editTool"]').forEach(checkbox => {
                checkbox.checked = currentTools.includes(checkbox.value);
            });
            
            // Handle tool preferences checkboxes - database values now match form values exactly
            let toolPreferences = [];
            if (Array.isArray(assessment.tool_preferences)) {
                toolPreferences = assessment.tool_preferences;
            } else if (typeof assessment.tool_preferences === 'string') {
                try {
                    toolPreferences = JSON.parse(assessment.tool_preferences);
                } catch (e) {
                    toolPreferences = assessment.tool_preferences.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            
            document.querySelectorAll('[id^="editPref"]').forEach(checkbox => {
                checkbox.checked = toolPreferences.includes(checkbox.value);
            });
            
            // Handle data governance checkboxes - database values now match form values exactly
            let dataGovernance = [];
            if (Array.isArray(assessment.data_governance)) {
                dataGovernance = assessment.data_governance;
            } else if (typeof assessment.data_governance === 'string') {
                try {
                    dataGovernance = JSON.parse(assessment.data_governance);
                } catch (e) {
                    dataGovernance = assessment.data_governance.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editDataGov"]').forEach(checkbox => {
                checkbox.checked = dataGovernance.includes(checkbox.value);
            });
            
            // Handle security requirements checkboxes - database values now match form values exactly
            let securityRequirements = [];
            if (Array.isArray(assessment.security_requirements)) {
                securityRequirements = assessment.security_requirements;
            } else if (typeof assessment.security_requirements === 'string') {
                try {
                    securityRequirements = JSON.parse(assessment.security_requirements);
                } catch (e) {
                    securityRequirements = assessment.security_requirements.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editSec"]').forEach(checkbox => {
                checkbox.checked = securityRequirements.includes(checkbox.value);
            });
            
            // Handle compliance needs checkboxes - database values now match form values exactly
            let complianceNeeds = [];
            if (Array.isArray(assessment.compliance_needs)) {
                complianceNeeds = assessment.compliance_needs;
            } else if (typeof assessment.compliance_needs === 'string') {
                try {
                    complianceNeeds = JSON.parse(assessment.compliance_needs);
                } catch (e) {
                    complianceNeeds = assessment.compliance_needs.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editComp"]').forEach(checkbox => {
                checkbox.checked = complianceNeeds.includes(checkbox.value);
            });
            
            // Handle integration requirements checkboxes - database values now match form values exactly
            let integrationRequirements = [];
            if (Array.isArray(assessment.integration_requirements)) {
                integrationRequirements = assessment.integration_requirements;
            } else if (typeof assessment.integration_requirements === 'string') {
                try {
                    integrationRequirements = JSON.parse(assessment.integration_requirements);
                } catch (e) {
                    integrationRequirements = assessment.integration_requirements.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editInt"]').forEach(checkbox => {
                checkbox.checked = integrationRequirements.includes(checkbox.value);
            });
            
            // Handle success metrics checkboxes - database values now match form values exactly
            let successMetrics = [];
            if (Array.isArray(assessment.success_metrics)) {
                successMetrics = assessment.success_metrics;
            } else if (typeof assessment.success_metrics === 'string') {
                try {
                    successMetrics = JSON.parse(assessment.success_metrics);
                } catch (e) {
                    successMetrics = assessment.success_metrics.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editMetric"]').forEach(checkbox => {
                checkbox.checked = successMetrics.includes(checkbox.value);
            });
            
            document.getElementById('editExpectedRoi').value = assessment.expected_roi || '';
            document.getElementById('editPaybackPeriod').value = assessment.payback_period || '';
            
            // Handle risk factors checkboxes - database values now match form values exactly
            let riskFactors = [];
            if (Array.isArray(assessment.risk_factors)) {
                riskFactors = assessment.risk_factors;
            } else if (typeof assessment.risk_factors === 'string') {
                try {
                    riskFactors = JSON.parse(assessment.risk_factors);
                } catch (e) {
                    riskFactors = assessment.risk_factors.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editRisk"]').forEach(checkbox => {
                checkbox.checked = riskFactors.includes(checkbox.value);
            });
            
            // Handle mitigation strategies checkboxes - database values now match form values exactly
            let mitigationStrategies = [];
            if (Array.isArray(assessment.mitigation_strategies)) {
                mitigationStrategies = assessment.mitigation_strategies;
            } else if (typeof assessment.mitigation_strategies === 'string') {
                try {
                    mitigationStrategies = JSON.parse(assessment.mitigation_strategies);
                } catch (e) {
                    mitigationStrategies = assessment.mitigation_strategies.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editMit"]').forEach(checkbox => {
                checkbox.checked = mitigationStrategies.includes(checkbox.value);
            });
            
            // Handle implementation phases checkboxes - database values now match form values exactly
            let implementationPhases = [];
            if (Array.isArray(assessment.implementation_phases)) {
                implementationPhases = assessment.implementation_phases;
            } else if (typeof assessment.implementation_phases === 'string') {
                try {
                    implementationPhases = JSON.parse(assessment.implementation_phases);
                } catch (e) {
                    implementationPhases = assessment.implementation_phases.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editPhase"]').forEach(checkbox => {
                checkbox.checked = implementationPhases.includes(checkbox.value);
            });
            
            // Handle resource requirements checkboxes - database values now match form values exactly
            let resourceRequirements = [];
            if (Array.isArray(assessment.resource_requirements)) {
                resourceRequirements = assessment.resource_requirements;
            } else if (typeof assessment.resource_requirements === 'string') {
                try {
                    resourceRequirements = JSON.parse(assessment.resource_requirements);
                } catch (e) {
                    resourceRequirements = assessment.resource_requirements.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editRes"]').forEach(checkbox => {
                checkbox.checked = resourceRequirements.includes(checkbox.value);
            });
            
            // Handle training needs checkboxes - database values now match form values exactly
            let trainingNeeds = [];
            if (Array.isArray(assessment.training_needs)) {
                trainingNeeds = assessment.training_needs;
            } else if (typeof assessment.training_needs === 'string') {
                try {
                    trainingNeeds = JSON.parse(assessment.training_needs);
                } catch (e) {
                    trainingNeeds = assessment.training_needs.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editTrain"]').forEach(checkbox => {
                checkbox.checked = trainingNeeds.includes(checkbox.value);
            });
            
            // Handle vendor criteria checkboxes - database values now match form values exactly
            let vendorCriteria = [];
            if (Array.isArray(assessment.vendor_criteria)) {
                vendorCriteria = assessment.vendor_criteria;
            } else if (typeof assessment.vendor_criteria === 'string') {
                try {
                    vendorCriteria = JSON.parse(assessment.vendor_criteria);
                } catch (e) {
                    vendorCriteria = assessment.vendor_criteria.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editVendor"]').forEach(checkbox => {
                checkbox.checked = vendorCriteria.includes(checkbox.value);
            });
            
            // Handle competitor analysis checkboxes - database values now match form values exactly
            let competitors = [];
            if (Array.isArray(assessment.competitors)) {
                competitors = assessment.competitors;
            } else if (typeof assessment.competitors === 'string') {
                try {
                    competitors = JSON.parse(assessment.competitors);
                } catch (e) {
                    competitors = assessment.competitors.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editCompetitor"]').forEach(checkbox => {
                checkbox.checked = competitors.includes(checkbox.value);
            });
            
            // Handle opportunities field
            document.getElementById('editOpportunities').value = JSON.stringify(assessment.opportunities || [], null, 2);
            
            // Handle Strategy Blueprint fields
            // Competitive Analysis - this is a checkbox group with "Other" input
            let competitiveAdvantages = [];
            if (Array.isArray(assessment.competitive_advantages)) {
                competitiveAdvantages = assessment.competitive_advantages;
            } else if (typeof assessment.competitive_advantages === 'string') {
                try {
                    competitiveAdvantages = JSON.parse(assessment.competitive_advantages);
                } catch (e) {
                    competitiveAdvantages = assessment.competitive_advantages.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editAdv"]').forEach(checkbox => {
                checkbox.checked = competitiveAdvantages.includes(checkbox.value);
            });
            document.getElementById('editCompetitiveAdvantagesOther').value = '';
            
            document.getElementById('editMarketPosition').value = assessment.market_position || '';
            
            // Vendor Evaluation
            let vendorFeatures = [];
            if (Array.isArray(assessment.vendor_features)) {
                vendorFeatures = assessment.vendor_features;
            } else if (typeof assessment.vendor_features === 'string') {
                try {
                    vendorFeatures = JSON.parse(assessment.vendor_features);
                } catch (e) {
                    vendorFeatures = assessment.vendor_features.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editVendorFeat"]').forEach(checkbox => {
                checkbox.checked = vendorFeatures.includes(checkbox.value);
            });
            
            // Risk Assessment
            document.getElementById('editRiskTolerance').value = assessment.risk_tolerance || '';
            let riskConcerns = [];
            if (Array.isArray(assessment.risk_concerns)) {
                riskConcerns = assessment.risk_concerns;
            } else if (typeof assessment.risk_concerns === 'string') {
                try {
                    riskConcerns = JSON.parse(assessment.risk_concerns);
                } catch (e) {
                    riskConcerns = assessment.risk_concerns.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editRiskConcern"]').forEach(checkbox => {
                checkbox.checked = riskConcerns.includes(checkbox.value);
            });
            
            // Change Management
            document.getElementById('editOrgStructure').value = assessment.org_structure || '';
            document.getElementById('editDecisionProcess').value = assessment.decision_process || '';
            
            // Team & Hiring
            document.getElementById('editTeamSize').value = assessment.team_size || '';
            
            // Skill Gaps - this is a checkbox group with "Other" input
            let skillGaps = [];
            if (Array.isArray(assessment.skill_gaps)) {
                skillGaps = assessment.skill_gaps;
            } else if (typeof assessment.skill_gaps === 'string') {
                try {
                    skillGaps = JSON.parse(assessment.skill_gaps);
                } catch (e) {
                    skillGaps = assessment.skill_gaps.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editSkillGap"]').forEach(checkbox => {
                checkbox.checked = skillGaps.includes(checkbox.value);
            });
            document.getElementById('editSkillGapsOther').value = '';
            
            // Budget Planning
            document.getElementById('editBudgetAllocation').value = assessment.budget_allocation || '';
            document.getElementById('editRoiTimeline').value = assessment.roi_timeline || '';
            
            // Success Metrics
            // Current KPIs - this is a checkbox group with "Other" input
            let currentKpis = [];
            if (Array.isArray(assessment.current_kpis)) {
                currentKpis = assessment.current_kpis;
            } else if (typeof assessment.current_kpis === 'string') {
                try {
                    currentKpis = JSON.parse(assessment.current_kpis);
                } catch (e) {
                    currentKpis = assessment.current_kpis.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editKpi"]').forEach(checkbox => {
                checkbox.checked = currentKpis.includes(checkbox.value);
            });
            document.getElementById('editCurrentKpisOther').value = '';
            
            let improvementGoals = [];
            if (Array.isArray(assessment.improvement_goals)) {
                improvementGoals = assessment.improvement_goals;
            } else if (typeof assessment.improvement_goals === 'string') {
                try {
                    improvementGoals = JSON.parse(assessment.improvement_goals);
                } catch (e) {
                    improvementGoals = assessment.improvement_goals.split(',').map(item => item.trim()).filter(item => item);
                }
            }
            document.querySelectorAll('[id^="editGoal"]').forEach(checkbox => {
                checkbox.checked = improvementGoals.includes(checkbox.value);
            });
            
            // Show modal
            console.log('Showing edit modal');
            const modal = document.getElementById('editModal');
            if (modal) {
                modal.style.display = 'block';
            } else {
                console.log('Modal element not found!');
            }
        })
        .catch(error => {
            console.error('Error fetching assessment details:', error);
            alert('Error loading assessment details. Please try again.');
        });
}

function saveAssessment() {
    const formData = {
        id: document.getElementById('editId').value,
        company_name: document.getElementById('editCompanyName').value,
        industry: document.getElementById('editIndustry').value,
        company_size: document.getElementById('editCompanySize').value,
        role: document.getElementById('editRole').value,
        website: document.getElementById('editWebsite').value,
        first_name: document.getElementById('editFirstName').value,
        last_name: document.getElementById('editLastName').value,
        email: document.getElementById('editEmail').value,
        phone: document.getElementById('editPhone').value,
        challenges: collectCheckboxValues('editChallenge', 'editChallengesOther'),
        current_tech: document.getElementById('editCurrentTech').value,
        ai_experience: document.getElementById('editAiExperience').value,
        budget: document.getElementById('editBudget').value,
        timeline: document.getElementById('editTimeline').value,
        current_tools: collectCheckboxValues('editTool', 'editCurrentToolsOther'),
        tool_preferences: collectCheckboxValues('editPref', 'editToolPreferencesOther'),
        implementation_priority: document.getElementById('editImplementationPriority').value,
        team_availability: document.getElementById('editTeamAvailability').value,
        change_management_experience: document.getElementById('editChangeManagementExperience').value,
        data_governance: collectCheckboxValues('editDataGov', 'editDataGovernanceOther'),
        security_requirements: collectCheckboxValues('editSec', 'editSecurityRequirementsOther'),
        compliance_needs: collectCheckboxValues('editComp', 'editComplianceNeedsOther'),
        integration_requirements: collectCheckboxValues('editInt', 'editIntegrationRequirementsOther'),
        success_metrics: collectCheckboxValues('editMetric', 'editSuccessMetricsOther'),
        expected_roi: document.getElementById('editExpectedRoi').value,
        payback_period: document.getElementById('editPaybackPeriod').value,
        risk_factors: collectCheckboxValues('editRisk', 'editRiskFactorsOther'),
        mitigation_strategies: collectCheckboxValues('editMit', 'editMitigationStrategiesOther'),
        implementation_phases: collectCheckboxValues('editPhase', 'editImplementationPhasesOther'),
        resource_requirements: collectCheckboxValues('editRes', 'editResourceRequirementsOther'),
        training_needs: collectCheckboxValues('editTrain', 'editTrainingNeedsOther'),
        vendor_criteria: collectCheckboxValues('editVendor', 'editVendorCriteriaOther'),
        competitors: collectCheckboxValues('editCompetitor', 'editCompetitorsOther'),
        competitive_advantages: collectCheckboxValues('editAdv', 'editCompetitiveAdvantagesOther'),
        market_position: document.getElementById('editMarketPosition').value,
        vendor_features: collectCheckboxValues('editVendorFeat', 'editVendorFeaturesOther'),
        risk_tolerance: document.getElementById('editRiskTolerance').value,
        risk_concerns: collectCheckboxValues('editRiskConcern', 'editRiskConcernsOther'),
        org_structure: document.getElementById('editOrgStructure').value,
        decision_process: document.getElementById('editDecisionProcess').value,
        team_size: document.getElementById('editTeamSize').value,
        skill_gaps: collectCheckboxValues('editSkillGap', 'editSkillGapsOther'),
        budget_allocation: document.getElementById('editBudgetAllocation').value,
        roi_timeline: document.getElementById('editRoiTimeline').value,
        current_kpis: collectCheckboxValues('editKpi', 'editCurrentKpisOther'),
        improvement_goals: collectCheckboxValues('editGoal', 'editImprovementGoalsOther'),
        ai_score: document.getElementById('editAiScore').value,
        report_type: document.getElementById('editReportType').value,
        opportunities: document.getElementById('editOpportunities').value
    };
    
    fetch('/api/update_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            closeModal('editModal');
            loadAssessments();
            alert('Assessment updated successfully!');
        } else {
            alert('Error updating assessment: ' + result.error);
        }
    })
    .catch(error => {
        alert('Network error updating assessment');
    });
}

function testModal() {
    console.log('testModal called');
    const modal = document.getElementById('editModal');
    console.log('Modal element:', modal);
    if (modal) {
        modal.style.display = 'block';
        console.log('Modal display set to block');
    } else {
        console.log('Modal element not found!');
    }
}

function generateReportFromEdit() {
    const assessmentId = document.getElementById('editId').value;
    if (!assessmentId) {
        alert('No assessment ID found. Please save changes first.');
        return;
    }
    
    if (!confirm('Generate a new HTML report for this assessment?')) {
        return;
    }
    
    // Show generating status
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '‚è≥ Generating Report...';
    button.disabled = true;
    
    // Generate the report
    fetch('/generate_report_from_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ assessment_id: assessmentId })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Open the report in a new window
            window.open(result.view_url, '_blank');
            alert('Report generated successfully!');
        } else {
            alert('Error generating report: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating report');
    })
    .finally(() => {
        // Restore button
        button.textContent = originalText;
        button.disabled = false;
    });
}

// Close modals when clicking outside
window.onclick = function(event) {
    if (event.target.classList.contains('modal')) {
        event.target.style.display = 'none';
    }
}

function toggleBatchDeleteButton() {
    const checkboxes = document.querySelectorAll('#assessmentsTableBody input[type="checkbox"]');
    const selectedCount = Array.from(checkboxes).filter(checkbox => checkbox.checked).length;
    document.getElementById('selectedCount').textContent = selectedCount + ' selected';
    document.getElementById('batchDeleteBtn').disabled = selectedCount === 0;
}

function batchDeleteAssessments() {
    const checkboxes = document.querySelectorAll('#assessmentsTableBody input[type="checkbox"]');
    const selectedIds = Array.from(checkboxes).filter(checkbox => checkbox.checked).map(checkbox => checkbox.value);

    if (!confirm(`Are you sure you want to delete ${selectedIds.length} assessments?`)) {
        return;
    }

    fetch('/api/batch_delete_assessments', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ ids: selectedIds })
    })
        .then(response => response.json())
        .then(result => {
            if (result.success) {
                loadAssessments();
                alert(`Successfully deleted ${result.deleted_count} assessments!`);
            } else {
                alert('Error deleting assessments: ' + result.error);
            }
        })
        .catch(error => {
            alert('Network error deleting assessments');
        });
}

function toggleSelectAll() {
    const checkboxes = document.querySelectorAll('#assessmentsTableBody input[type="checkbox"]');
    const headerCheckbox = document.getElementById('headerSelectAll');

    if (headerCheckbox.checked) {
        checkboxes.forEach(checkbox => checkbox.checked = true);
    } else {
        checkboxes.forEach(checkbox => checkbox.checked = false);
    }

    toggleBatchDeleteButton();
}

function generateAssessmentReportFromView(assessmentId) {
    if (!confirm('Generate an Assessment Report for this client?')) {
        return;
    }
    
    // Show generating status
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '‚è≥ Generating Assessment Report...';
    button.disabled = true;
    
    // Generate the Assessment Report
    fetch('/generate_report_from_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            assessment_id: assessmentId,
            report_type: 'assessment'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Open the report in a new window
            window.open(result.view_url, '_blank');
            alert('Assessment Report generated successfully!');
        } else {
            alert('Error generating Assessment Report: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating Assessment Report');
    })
    .finally(() => {
        // Restore button
        button.textContent = originalText;
        button.disabled = false;
    });
}

function generateStrategyReportFromView(assessmentId) {
    if (!confirm('Generate a Strategic Blueprint Report for this client?')) {
        return;
    }
    
    // Show generating status
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = '‚è≥ Generating Strategic Blueprint...';
    button.disabled = true;
    
    // Generate the Strategic Blueprint Report
    fetch('/generate_report_from_assessment', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ 
            assessment_id: assessmentId,
            report_type: 'strategy'
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Open the report in a new window
            window.open(result.view_url, '_blank');
            alert('Strategic Blueprint Report generated successfully!');
        } else {
            alert('Error generating Strategic Blueprint Report: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error generating Strategic Blueprint Report');
    })
    .finally(() => {
        // Restore button
        button.textContent = originalText;
        button.disabled = false;
    });
}

// Enhanced checkbox options management
function manageCheckboxOptions(fieldName) {
    console.log('Managing checkbox options for:', fieldName);
    
    // First, load the dropdown options for this field (checkbox options are stored in the same table)
    fetch(`/api/dropdown_options?field_name=${fieldName}`)
        .then(response => response.json())
        .then(data => {
            console.log('Checkbox options data:', data);
            
            let optionsHtml = '';
            if (data.success && data.options && data.options.length > 0) {
                optionsHtml = data.options.map(option => `
                    <div class="option-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                        <input type="text" value="${option.option_value || ''}" placeholder="Value" 
                               onchange="updateDropdownOptionValue('${option.id}', this.value)"
                               style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <input type="text" value="${option.option_label || ''}" placeholder="Label" 
                               onchange="updateDropdownOptionLabel('${option.id}', this.value)"
                               style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <input type="number" value="${option.sort_order || 0}" placeholder="Order" 
                               onchange="updateDropdownOptionOrder('${option.id}', this.value)"
                               style="width: 60px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <button onclick="deleteDropdownOption('${option.id}')" 
                                style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Delete</button>
                    </div>
                `).join('');
            } else {
                optionsHtml = '<p style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">No options configured yet. Add your first option below.</p>';
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3 style="margin-bottom: 1rem; color: #1f2937;">Manage Checkbox Options for "${fieldName}"</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #374151;">Current Options (${data.success && data.options ? data.options.length : 0}):</h4>
                        <div id="checkboxOptionsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 6px; background: white;">
                            ${optionsHtml}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 6px;">
                        <input type="text" id="newCheckboxValue" placeholder="New option value (e.g., 'new-value')" 
                               style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <input type="text" id="newCheckboxLabel" placeholder="New option label (e.g., 'New Option')" 
                               style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <button onclick="addCheckboxOptionToField('${fieldName}')" 
                                style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500;">
                            ‚ûï Add Option
                        </button>
                    </div>
                    
                    <div style="text-align: right; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        })
        .catch(error => {
            console.error('Error loading checkbox options:', error);
            alert('Error loading checkbox options. Please try again.');
        });
}

// Enhanced dropdown options management
function manageDropdownOptions(fieldName) {
    console.log('Managing dropdown options for:', fieldName);
    
    // First, load the dropdown options for this field
    fetch(`/api/dropdown_options?field_name=${fieldName}`)
        .then(response => response.json())
        .then(data => {
            console.log('Dropdown options data:', data);
            
            let optionsHtml = '';
            if (data.success && data.options && data.options.length > 0) {
                optionsHtml = data.options.map(option => `
                    <div class="option-item" style="display: flex; gap: 8px; margin-bottom: 8px; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 4px; background: #f9fafb;">
                        <input type="text" value="${option.option_value || ''}" placeholder="Value" 
                               onchange="updateDropdownOptionValue('${option.id}', this.value)"
                               style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <input type="text" value="${option.option_label || ''}" placeholder="Label" 
                               onchange="updateDropdownOptionLabel('${option.id}', this.value)"
                               style="flex: 1; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <input type="number" value="${option.sort_order || 0}" placeholder="Order" 
                               onchange="updateDropdownOptionOrder('${option.id}', this.value)"
                               style="width: 60px; padding: 6px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <button onclick="deleteDropdownOption('${option.id}')" 
                                style="background: #ef4444; color: white; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-size: 12px;">üóëÔ∏è Delete</button>
                    </div>
                `).join('');
            } else {
                optionsHtml = '<p style="color: #6b7280; font-style: italic; text-align: center; padding: 20px;">No options configured yet. Add your first option below.</p>';
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <span class="close" onclick="this.parentElement.parentElement.remove()">&times;</span>
                    <h3 style="margin-bottom: 1rem; color: #1f2937;">Manage Dropdown Options for "${fieldName}"</h3>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <h4 style="margin-bottom: 0.5rem; color: #374151;">Current Options (${data.success && data.options ? data.options.length : 0}):</h4>
                        <div id="dropdownOptionsList" style="max-height: 400px; overflow-y: auto; border: 1px solid #e5e7eb; padding: 1rem; border-radius: 6px; background: white;">
                            ${optionsHtml}
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; margin-bottom: 1rem; padding: 1rem; background: #f3f4f6; border-radius: 6px;">
                        <input type="text" id="newOptionValue" placeholder="New option value (e.g., 'new-value')" 
                               style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <input type="text" id="newOptionLabel" placeholder="New option label (e.g., 'New Option')" 
                               style="flex: 1; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <button onclick="addDropdownOptionToField('${fieldName}')" 
                                style="background: #10b981; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-weight: 500;">
                            ‚ûï Add Option
                        </button>
                    </div>
                    
                    <div style="text-align: right; border-top: 1px solid #e5e7eb; padding-top: 1rem;">
                        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                                style="background: #6b7280; color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                            Close
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        })
        .catch(error => {
            console.error('Error loading dropdown options:', error);
            alert('Error loading dropdown options. Please try again.');
        });
}

// Helper functions for updating dropdown options
function updateDropdownOptionValue(optionId, value) {
    fetch(`/api/dropdown_options/${optionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            option_value: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Option value updated successfully');
            showNotification('Option value updated successfully', 'success');
        } else {
            console.error('Error updating option value:', data.error);
            showNotification('Error updating option value: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error updating option value', 'error');
    });
}

function updateDropdownOptionLabel(optionId, value) {
    fetch(`/api/dropdown_options/${optionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            option_label: value
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Option label updated successfully');
            showNotification('Option label updated successfully', 'success');
        } else {
            console.error('Error updating option label:', data.error);
            showNotification('Error updating option label: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error updating option label', 'error');
    });
}

function updateDropdownOptionOrder(optionId, value) {
    fetch(`/api/dropdown_options/${optionId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            sort_order: parseInt(value)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Option order updated successfully');
            showNotification('Option order updated successfully', 'success');
        } else {
            console.error('Error updating option order:', data.error);
            showNotification('Error updating option order: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error updating option order', 'error');
    });
}

function deleteDropdownOption(optionId) {
    if (!confirm('Are you sure you want to delete this option? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/dropdown_options/${optionId}`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            console.log('Option deleted successfully');
            showNotification('Option deleted successfully', 'success');
            // Refresh the modal to show updated list
            const modal = document.querySelector('.modal');
            if (modal) {
                const fieldName = modal.querySelector('h3').textContent.match(/"([^"]+)"/)[1];
                modal.remove();
                if (fieldName.includes('Checkbox')) {
                    manageCheckboxOptions(fieldName.replace('Manage Checkbox Options for "', '').replace('"', ''));
                } else {
                    manageDropdownOptions(fieldName.replace('Manage Dropdown Options for "', '').replace('"', ''));
                }
            }
        } else {
            console.error('Error deleting option:', data.error);
            showNotification('Error deleting option: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error deleting option', 'error');
    });
}

// Enhanced add functions
function addDropdownOptionToField(fieldName) {
    const value = document.getElementById('newOptionValue').value.trim();
    const label = document.getElementById('newOptionLabel').value.trim();
    
    if (!value || !label) {
        showNotification('Please enter both value and label', 'error');
        return;
    }
    
    fetch('/api/dropdown_options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            field_name: fieldName,
            option_value: value,
            option_label: label,
            sort_order: 0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Dropdown option added successfully!', 'success');
            // Clear the input fields
            document.getElementById('newOptionValue').value = '';
            document.getElementById('newOptionLabel').value = '';
            // Refresh the modal
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
                manageDropdownOptions(fieldName);
            }
        } else {
            showNotification('Error adding option: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error adding option', 'error');
    });
}

function addCheckboxOptionToField(fieldName) {
    const value = document.getElementById('newCheckboxValue').value.trim();
    const label = document.getElementById('newCheckboxLabel').value.trim();
    
    if (!value || !label) {
        showNotification('Please enter both value and label', 'error');
        return;
    }
    
    fetch('/api/dropdown_options', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            field_name: fieldName,
            option_value: value,
            option_label: label,
            sort_order: 0
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Checkbox option added successfully!', 'success');
            // Clear the input fields
            document.getElementById('newCheckboxValue').value = '';
            document.getElementById('newCheckboxLabel').value = '';
            // Refresh the modal
            const modal = document.querySelector('.modal');
            if (modal) {
                modal.remove();
                manageCheckboxOptions(fieldName);
            }
        } else {
            showNotification('Error adding option: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error adding option', 'error');
    });
}

// Notification function for better user feedback
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 20px;
        border-radius: 6px;
        color: white;
        font-weight: 500;
        z-index: 10000;
        max-width: 300px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
    `;
    
    if (type === 'success') {
        notification.style.background = '#10b981';
    } else if (type === 'error') {
        notification.style.background = '#ef4444';
    } else {
        notification.style.background = '#3b82f6';
    }
    
    notification.textContent = message;
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add CSS for notifications
const style = document.createElement('style');
style.textContent = `
    @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(style);

// Navigation functions
function showSection(sectionName, event = null) {
    // Hide all sections
    document.querySelectorAll('.content-section').forEach(section => {
        section.style.display = 'none';
    });
    
    // Remove active class from all tabs
    document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = '#f8fafc';
        tab.style.color = '#6b7280';
        tab.style.borderBottom = 'none';
    });
    
    // Show selected section
    const selectedSection = document.getElementById(sectionName + 'Section');
    if (selectedSection) {
        selectedSection.style.display = 'block';
    }
    
    // Add active class to selected tab if event is provided
    if (event && event.target) {
        const selectedTab = event.target;
        selectedTab.classList.add('active');
        selectedTab.style.background = '#fff';
        selectedTab.style.color = '#dc2626';
        selectedTab.style.borderBottom = '3px solid #dc2626';
    }
    
    // Load data for the selected section
    if (sectionName === 'assessments') {
        loadAssessments();
    } else if (sectionName === 'formBuilder') {
        loadFormBuilder();
    } else if (sectionName === 'database') {
        loadDatabaseView();
    }
}

// Form Builder functions
function loadFormBuilder() {
    console.log('Loading form builder...');
    loadAllConfigurations();
}

function loadAllConfigurations() {
    console.log('Loading all configurations...');
    // Load sections first, then fields, then dropdown options
    loadSectionConfigurations().then(() => {
        loadFieldConfigurations();
        loadDropdownFieldOptions();
    });
}

function loadSectionConfigurations() {
    console.log('Loading section configurations...');
    return fetch('/api/section_configurations')
        .then(response => response.json())
        .then(data => {
            console.log('Section configurations data:', data);
            if (data.success) {
                window.sectionConfigurations = data.configurations;
                renderSectionConfigTable(data.configurations);
                return data.configurations;
            } else {
                console.error('Error loading section configurations:', data.error);
                return [];
            }
        })
        .catch(error => {
            console.error('Error:', error);
            return [];
        });
}

function loadFieldConfigurations() {
    console.log('Loading field configurations...');
    const formFilter = document.getElementById('formFilter').value;
    const url = formFilter ? `/api/field_configurations?form_flag=${formFilter}` : '/api/field_configurations';
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            console.log('Field configurations data:', data);
            if (data.success) {
                renderFieldConfigTable(data.configurations);
            } else {
                console.error('Error loading field configurations:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function renderFieldConfigTable(configurations) {
    const tbody = document.getElementById('fieldConfigTableBody');
    if (!tbody) {
        console.error('Field config table body not found');
        return;
    }
    
    tbody.innerHTML = configurations.map(config => `
        <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px;">${config.field_name || ''}</td>
            <td style="padding: 12px;">${config.field_label || ''}</td>
            <td style="padding: 12px;">
                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; background: ${getTypeColor(config.field_type)}; color: white;">
                    ${config.field_type || ''}
                </span>
            </td>
            <td style="padding: 12px;">
                <select onchange="updateFieldSection('${config.field_name}', this.value)" style="padding: 4px 8px; border: 1px solid #d1d5db; border-radius: 4px; background: white;">
                    <option value="">Select a section...</option>
                    ${window.sectionConfigurations ? window.sectionConfigurations.map(section => 
                        `<option value="${section.section_name}" ${config.section_name === section.section_name ? 'selected' : ''}>
                            ${section.section_title}
                        </option>`
                    ).join('') : ''}
                </select>
            </td>
            <td style="padding: 12px;">
                <span style="padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; background: ${config.form_flag === 'A' ? '#3b82f6' : '#10b981'}; color: white;">
                    ${config.form_flag === 'A' ? 'Assessment' : 'Strategy'}
                </span>
            </td>
            <td style="padding: 12px;">
                <div style="display: flex; gap: 4px;">
                    <button class="action-btn" onclick="editFieldConfig('${config.field_name}')" style="background: #3b82f6; color: white;" title="Edit Field">‚úèÔ∏è</button>
                    ${config.field_type === 'select' ? 
                        `<button class="action-btn" onclick="manageDropdownOptions('${config.field_name}')" style="background: #3b82f6; color: white;" title="Manage Dropdown Options">üìù</button>` : ''
                    }
                    ${config.field_type === 'checkbox' ? 
                        `<button class="action-btn" onclick="manageCheckboxOptions('${config.field_name}')" style="background: #10b981; color: white;" title="Manage Checkbox Options">‚òëÔ∏è</button>` : ''
                    }
                </div>
            </td>
        </tr>
    `).join('');
}

function getTypeColor(type) {
    const colors = {
        'text': '#3b82f6',
        'email': '#8b5cf6',
        'tel': '#f59e0b',
        'url': '#10b981',
        'select': '#ef4444',
        'checkbox': '#06b6d4'
    };
    return colors[type] || '#6b7280';
}

function renderSectionConfigTable(configurations) {
    const tbody = document.getElementById('sectionConfigTableBody');
    if (!tbody) {
        console.error('Section config table body not found');
        return;
    }
    
    tbody.innerHTML = configurations.map(config => `
        <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px;">${config.section_name || ''}</td>
            <td style="padding: 12px;">${config.section_title || ''}</td>
            <td style="padding: 12px;">${config.step_number || ''}</td>
            <td style="padding: 12px;">${config.description || ''}</td>
            <td style="padding: 12px;">
                <div style="display: flex; gap: 4px;">
                    <button class="action-btn" onclick="editSectionConfig('${config.section_name}')" style="background: #3b82f6; color: white;" title="Edit Section">‚úèÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function loadDropdownFieldOptions() {
    console.log('Loading dropdown options...');
    fetch('/api/dropdown_options')
        .then(response => response.json())
        .then(data => {
            console.log('Dropdown options data:', data);
            if (data.success) {
                window.dropdownOptions = data.options;
                renderDropdownOptionsTable(data.options);
            } else {
                console.error('Error loading dropdown options:', data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
}

function renderDropdownOptionsTable(options) {
    const tbody = document.getElementById('dropdownOptionsTableBody');
    if (!tbody) {
        console.error('Dropdown options table body not found');
        return;
    }
    
    tbody.innerHTML = options.map(option => `
        <tr style="border-bottom: 1px solid #e5e7eb;">
            <td style="padding: 12px;">${option.field_name || ''}</td>
            <td style="padding: 12px;">${option.option_value || ''}</td>
            <td style="padding: 12px;">${option.option_label || ''}</td>
            <td style="padding: 12px;">${option.sort_order || 0}</td>
            <td style="padding: 12px;">
                <div style="display: flex; gap: 4px;">
                    <button class="action-btn" onclick="editDropdownOption(${option.id})" style="background: #3b82f6; color: white;" title="Edit Option">‚úèÔ∏è</button>
                </div>
            </td>
        </tr>
    `).join('');
}

function filterFieldsByForm() {
    console.log('Filtering fields by form...');
    loadFieldConfigurations();
}

function updateFieldSection(fieldName, sectionName) {
    console.log('Updating field section:', fieldName, sectionName);
    fetch(`/api/field_configurations/${fieldName}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ section_name: sectionName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Field section updated successfully', 'success');
        } else {
            showNotification('Error updating field section: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error updating field section', 'error');
    });
}

function editFieldConfig(fieldName) {
    console.log('Editing field config:', fieldName);
    
    // Find the field configuration
    fetch(`/api/field_configurations?form_flag=`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const field = data.configurations.find(f => f.field_name === fieldName);
                if (field) {
                    showEditFieldModal(field);
                } else {
                    showNotification('Field not found', 'error');
                }
            } else {
                showNotification('Error loading field data: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showNotification('Network error loading field data', 'error');
        });
}

function showEditFieldModal(field) {
    // Create modal HTML
    const modalHtml = `
        <div id="editFieldModal" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div style="background: white; padding: 2rem; border-radius: 8px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">Edit Field Configuration</h3>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Field Name:</label>
                    <input type="text" id="editFieldName" value="${field.field_name}" readonly style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; background: #f9fafb;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Field Label:</label>
                    <input type="text" id="editFieldLabel" value="${field.field_label || ''}" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Field Type:</label>
                    <select id="editFieldType" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <option value="text" ${field.field_type === 'text' ? 'selected' : ''}>Text</option>
                        <option value="email" ${field.field_type === 'email' ? 'selected' : ''}>Email</option>
                        <option value="tel" ${field.field_type === 'tel' ? 'selected' : ''}>Phone</option>
                        <option value="url" ${field.field_type === 'url' ? 'selected' : ''}>URL</option>
                        <option value="select" ${field.field_type === 'select' ? 'selected' : ''}>Dropdown</option>
                        <option value="checkbox" ${field.field_type === 'checkbox' ? 'selected' : ''}>Checkbox</option>
                        <option value="textarea" ${field.field_type === 'textarea' ? 'selected' : ''}>Text Area</option>
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Section:</label>
                    <select id="editFieldSection" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px;">
                        <option value="">Select a section...</option>
                        ${window.sectionConfigurations ? window.sectionConfigurations.map(section => 
                            `<option value="${section.section_name}" ${field.section_name === section.section_name ? 'selected' : ''}>
                                ${section.section_title}
                            </option>`
                        ).join('') : ''}
                    </select>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Required:</label>
                    <input type="checkbox" id="editFieldRequired" ${field.is_required ? 'checked' : ''} style="margin-right: 0.5rem;">
                    <span>This field is required</span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Visible:</label>
                    <input type="checkbox" id="editFieldVisible" ${field.is_visible ? 'checked' : ''} style="margin-right: 0.5rem;">
                    <span>This field is visible</span>
                </div>
                
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Help Text:</label>
                    <textarea id="editFieldHelpText" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 4px; height: 80px;">${field.help_text || ''}</textarea>
                </div>
                
                <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                    <button onclick="closeEditFieldModal()" style="padding: 8px 16px; border: 1px solid #d1d5db; background: white; border-radius: 4px; cursor: pointer;">Cancel</button>
                    <button onclick="saveFieldConfig()" style="padding: 8px 16px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Save Changes</button>
                </div>
            </div>
        </div>
    `;
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHtml);
}

function closeEditFieldModal() {
    const modal = document.getElementById('editFieldModal');
    if (modal) {
        modal.remove();
    }
}

function saveFieldConfig() {
    const fieldName = document.getElementById('editFieldName').value;
    const fieldLabel = document.getElementById('editFieldLabel').value;
    const fieldType = document.getElementById('editFieldType').value;
    const fieldSection = document.getElementById('editFieldSection').value;
    const fieldRequired = document.getElementById('editFieldRequired').checked;
    const fieldVisible = document.getElementById('editFieldVisible').checked;
    const fieldHelpText = document.getElementById('editFieldHelpText').value;
    
    const updateData = {
        field_label: fieldLabel,
        field_type: fieldType,
        section_name: fieldSection,
        is_required: fieldRequired,
        is_visible: fieldVisible,
        help_text: fieldHelpText
    };
    
    fetch(`/api/field_configurations/${fieldName}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showNotification('Field configuration updated successfully', 'success');
            closeEditFieldModal();
            loadFieldConfigurations(); // Refresh the table
        } else {
            showNotification('Error updating field: ' + data.error, 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showNotification('Network error updating field', 'error');
    });
}

function editSectionConfig(sectionName) {
    console.log('Editing section config:', sectionName);
    // Implementation for editing section configuration
    showNotification('Edit section configuration feature coming soon', 'info');
}

function editDropdownOption(optionId) {
    console.log('Editing dropdown option:', optionId);
    // Implementation for editing dropdown option
    showNotification('Edit dropdown option feature coming soon', 'info');
}

function loadDatabaseView() {
    console.log('Loading database view...');
    // Show the database view and load the data
    const databaseView = document.getElementById('databaseView');
    if (databaseView) {
        databaseView.style.display = 'block';
    }
    loadDbRows();
}

function toggleDatabaseView(event) {
    const view = document.getElementById('databaseView');
    const button = event.target;
    
    if (view.style.display === 'none') {
        view.style.display = 'block';
        button.textContent = 'Hide Database View';
    } else {
        view.style.display = 'none';
        button.textContent = 'Show Database View';
    }
}

// Initialize the page
document.addEventListener('DOMContentLoaded', function() {
    console.log('Admin page loaded');
    // Show assessments section by default
    showSection('assessments');
});
</script>

{% endblock %}